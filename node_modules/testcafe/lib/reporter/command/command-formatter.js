"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.CommandFormatter = void 0;
const lodash_1 = require("lodash");
const observation_1 = require("../../test-run/commands/observation");
const actions_1 = require("../../test-run/commands/actions");
const replicator_1 = require("../../client-functions/replicator");
const diff_1 = __importDefault(require("../../utils/diff"));
const options_1 = require("../../test-run/commands/options");
const type_1 = __importDefault(require("../../test-run/commands/type"));
const assertion_1 = require("../../test-run/commands/assertion");
const CONFIDENTIAL_INFO_PLACEHOLDER = '********';
function isCommandOptions(obj) {
    return obj instanceof options_1.ActionOptions || obj instanceof options_1.ResizeToFitDeviceOptions || obj instanceof options_1.AssertionOptions;
}
class CommandFormatter {
    constructor(command, result) {
        this._elements = [];
        this._command = command;
        this._result = result;
    }
    format() {
        const formattedCommand = { type: this._command.type, actionId: this._command.actionId };
        if (this._command instanceof observation_1.ExecuteSelectorCommand)
            formattedCommand.selector = this._prepareSelector(this._command, 'selector');
        else if (this._command instanceof observation_1.ExecuteClientFunctionCommand)
            formattedCommand.clientFn = this._prepareClientFunction(this._command);
        else if (this._command instanceof actions_1.UseRoleCommand)
            formattedCommand.role = this._prepareRole(this._command);
        else if (this._command instanceof actions_1.NavigateToCommand)
            formattedCommand.url = this._prepareUrl(this._command);
        else if (this._command instanceof actions_1.SetNativeDialogHandlerCommand)
            formattedCommand.dialogHandler = this._prepareDialogHandler(this._command);
        else
            this._assignProperties(this._command, formattedCommand);
        this._maskConfidentialInfo(formattedCommand);
        return formattedCommand;
    }
    _maskConfidentialInfo(command) {
        var _a;
        if (!((_a = command.options) === null || _a === void 0 ? void 0 : _a.confidential))
            return;
        if (this._command instanceof actions_1.TypeTextCommand)
            command.text = CONFIDENTIAL_INFO_PLACEHOLDER;
        else if (this._command instanceof actions_1.PressKeyCommand)
            command.keys = CONFIDENTIAL_INFO_PLACEHOLDER;
    }
    _getElementByPropertyName(propertyName) {
        this._ensureSelectorElements();
        switch (propertyName) {
            case 'selector':
            case 'startSelector':
                return this._elements[0];
            case 'endSelector':
            case 'destinationSelector':
                return this._elements[1];
        }
        return this._elements[0];
    }
    _prepareSelector(command, propertyName) {
        const selectorChain = command.apiFnChain;
        const expression = selectorChain.join('');
        const result = { expression };
        let element = null;
        if (this._result)
            element = this._getElementByPropertyName(propertyName);
        if (element)
            result.element = element;
        if (command.timeout)
            result.timeout = command.timeout;
        return result;
    }
    _prepareClientFunction(command) {
        return {
            code: command.fnCode,
            args: command.args[0],
        };
    }
    _prepareDialogHandler(command) {
        return this._prepareClientFunction(command.dialogHandler);
    }
    _prepareRole(command) {
        const { loginUrl, opts, phase } = command.role;
        return { loginUrl, options: opts, phase };
    }
    _prepareUrl(command) {
        return command.url;
    }
    _filterNotReportedProperties(properties, commandType) {
        if (commandType !== type_1.default.assertion)
            return properties;
        return properties.filter(prop => !assertion_1.AssertionCommand.NOT_REPORTED_PROPERTIES.includes(prop));
    }
    _assignProperties(command, formattedCommand) {
        if (!this._command._getAssignableProperties)
            return;
        let sourceProperties = this._command._getAssignableProperties().map(prop => prop.name);
        sourceProperties = this._filterNotReportedProperties(sourceProperties, this._command.type);
        sourceProperties.forEach((key) => {
            const property = this._command[key];
            if (property instanceof observation_1.ExecuteSelectorCommand)
                formattedCommand[key] = this._prepareSelector(property, key);
            else if (isCommandOptions(property)) {
                const modifiedOptions = CommandFormatter._getModifiedOptions(property);
                if (!lodash_1.isEmpty(modifiedOptions))
                    formattedCommand[key] = modifiedOptions;
            }
            else
                formattedCommand[key] = property;
        });
    }
    _ensureSelectorElements() {
        if (!this._result || this._elements.length)
            return;
        const decoded = replicator_1.createReplicator(new replicator_1.SelectorNodeTransform()).decode(this._result);
        this._elements = Array.isArray(decoded) ? decoded : [decoded];
    }
    static _getModifiedOptions(commandOptions) {
        const constructor = commandOptions.constructor;
        const defaultOptions = new constructor();
        return diff_1.default(defaultOptions, commandOptions);
    }
}
exports.CommandFormatter = CommandFormatter;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29tbWFuZC1mb3JtYXR0ZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvcmVwb3J0ZXIvY29tbWFuZC9jb21tYW5kLWZvcm1hdHRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQSxtQ0FBaUM7QUFDakMscUVBQTJHO0FBQzNHLDZEQU15QztBQUV6QyxrRUFBNEY7QUFJNUYsNERBQW9DO0FBRXBDLDZEQUl5QztBQUd6Qyx3RUFBdUQ7QUFDdkQsaUVBQXFFO0FBR3JFLE1BQU0sNkJBQTZCLEdBQUcsVUFBVSxDQUFDO0FBRWpELFNBQVMsZ0JBQWdCLENBQUUsR0FBVztJQUNsQyxPQUFPLEdBQUcsWUFBWSx1QkFBYSxJQUFJLEdBQUcsWUFBWSxrQ0FBd0IsSUFBSSxHQUFHLFlBQVksMEJBQWdCLENBQUM7QUFDdEgsQ0FBQztBQUVELE1BQWEsZ0JBQWdCO0lBS3pCLFlBQW9CLE9BQW9CLEVBQUUsTUFBZTtRQUpqRCxjQUFTLEdBQWtCLEVBQUUsQ0FBQztRQUtsQyxJQUFJLENBQUMsUUFBUSxHQUFHLE9BQU8sQ0FBQztRQUN4QixJQUFJLENBQUMsT0FBTyxHQUFHLE1BQU0sQ0FBQztJQUMxQixDQUFDO0lBRU0sTUFBTTtRQUNULE1BQU0sZ0JBQWdCLEdBQXFCLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxFQUFFLFFBQVEsRUFBRSxJQUFJLENBQUMsUUFBUSxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBRTFHLElBQUksSUFBSSxDQUFDLFFBQVEsWUFBWSxvQ0FBc0I7WUFDL0MsZ0JBQWdCLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLFVBQVUsQ0FBQyxDQUFDO2FBQzVFLElBQUksSUFBSSxDQUFDLFFBQVEsWUFBWSwwQ0FBNEI7WUFDMUQsZ0JBQWdCLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxJQUFJLENB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QU0sZUFBZSxHQUFHLGdCQUFnQixDQUFDLG1CQUFtQixDQUFDLFFBQWtCLENBQUMsQ0FBQztnQkFFakYsSUFBSSxDQUFDLGdCQUFPLENBQUMsZUFBZSxDQUFDO29CQUN6QixnQkFBZ0IsQ0FBQyxHQUFHLENBQUMsR0FBRyxlQUFlLENBQUM7YUFDL0M7O2dCQUVHLGdCQUFnQixDQUFDLEdBQUcsQ0FBQyxHQUFHLFFBQVEsQ0FBQztRQUN6QyxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7SUFFTyx1QkFBdUI7UUFDM0IsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNO1lBQ3RDLE9BQU87UUFFWCxNQUFNLE9BQU8sR0FBRyw2QkFBZ0IsQ0FBQyxJQUFJLGtDQUFxQixFQUFFLENBQUMsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBRW5GLElBQUksQ0FBQyxTQUFTLEdBQUcsS0FBSyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQ2xFLENBQUM7SUFFTyxNQUFNLENBQUMsbUJBQW1CLENBQUUsY0FBc0I7UUFDdEQsTUFBTSxXQUFXLEdBQU0sY0FBYyxDQUFDLFdBQWdDLENBQUM7UUFDdkUsTUFBTSxjQUFjLEdBQUcsSUFBSSxXQUFXLEVBQUUsQ0FBQztRQUV6QyxPQUFPLGNBQUksQ0FBQyxjQUFvQyxFQUFFLGNBQW9DLENBQUMsQ0FBQztJQUM1RixDQUFDO0NBQ0o7QUEvSUQsNENBK0lDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgaXNFbXB0eSB9IGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyBFeGVjdXRlU2VsZWN0b3JDb21tYW5kLCBFeGVjdXRlQ2xpZW50RnVuY3Rpb25Db21tYW5kIH0gZnJvbSAnLi4vLi4vdGVzdC1ydW4vY29tbWFuZHMvb2JzZXJ2YXRpb24nO1xuaW1wb3J0IHtcbiAgICBOYXZpZ2F0ZVRvQ29tbWFuZCxcbiAgICBQcmVzc0tleUNvbW1hbmQsXG4gICAgU2V0TmF0aXZlRGlhbG9nSGFuZGxlckNvbW1hbmQsXG4gICAgVHlwZVRleHRDb21tYW5kLFxuICAgIFVzZVJvbGVDb21tYW5kLFxufSBmcm9tICcuLi8uLi90ZXN0LXJ1bi9jb21tYW5kcy9hY3Rpb25zJztcblxuaW1wb3J0IHsgY3JlYXRlUmVwbGljYXRvciwgU2VsZWN0b3JOb2RlVHJhbnNmb3JtIH0gZnJvbSAnLi4vLi4vY2xpZW50LWZ1bmN0aW9ucy9yZXBsaWNhdG9yJztcbmltcG9ydCB7IEZvcm1hdHRlZENvbW1hbmQsIFNlbGVjdG9ySW5mbyB9IGZyb20gJy4vaW50ZXJmYWNlcyc7XG5cbmltcG9ydCB7IERpY3Rpb25hcnkgfSBmcm9tICcuLi8uLi9jb25maWd1cmF0aW9uL2ludGVyZmFjZXMnO1xuaW1wb3J0IGRpZmYgZnJvbSAnLi4vLi4vdXRpbHMvZGlmZic7XG5cbmltcG9ydCB7XG4gICAgQWN0aW9uT3B0aW9ucyxcbiAgICBSZXNpemVUb0ZpdERldmljZU9wdGlvbnMsXG4gICAgQXNzZXJ0aW9uT3B0aW9ucyxcbn0gZnJvbSAnLi4vLi4vdGVzdC1ydW4vY29tbWFuZHMvb3B0aW9ucyc7XG5cbmltcG9ydCB7IENvbW1hbmRCYXNlIH0gZnJvbSAnLi4vLi4vdGVzdC1ydW4vY29tbWFuZHMvYmFzZSc7XG5pbXBvcnQgQ29tbWFuZFR5cGUgZnJvbSAnLi4vLi4vdGVzdC1ydW4vY29tbWFuZHMvdHlwZSc7XG5pbXBvcnQgeyBBc3NlcnRpb25Db21tYW5kIH0gZnJvbSAnLi4vLi4vdGVzdC1ydW4vY29tbWFuZHMvYXNzZXJ0aW9uJztcblxuXG5jb25zdCBDT05GSURFTlRJQUxfSU5GT19QTEFDRUhPTERFUiA9ICcqKioqKioqKic7XG5cbmZ1bmN0aW9uIGlzQ29tbWFuZE9wdGlvbnMgKG9iajogb2JqZWN0KTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIG9iaiBpbnN0YW5jZW9mIEFjdGlvbk9wdGlvbnMgfHwgb2JqIGluc3RhbmNlb2YgUmVzaXplVG9GaXREZXZpY2VPcHRpb25zIHx8IG9iaiBpbnN0YW5jZW9mIEFzc2VydGlvbk9wdGlvbnM7XG59XG5cbmV4cG9ydCBjbGFzcyBDb21tYW5kRm9ybWF0dGVyIHtcbiAgICBwcml2YXRlIF9lbGVtZW50czogSFRNTEVsZW1lbnRbXSA9IFtdO1xuICAgIHByaXZhdGUgcmVhZG9ubHkgX2NvbW1hbmQ6IENvbW1hbmRCYXNlO1xuICAgIHByaXZhdGUgcmVhZG9ubHkgX3Jlc3VsdDogdW5rbm93bjtcblxuICAgIHB1YmxpYyBjb25zdHJ1Y3RvciAoY29tbWFuZDogQ29tbWFuZEJhc2UsIHJlc3VsdDogdW5rbm93bikge1xuICAgICAgICB0aGlzLl9jb21tYW5kID0gY29tbWFuZDtcbiAgICAgICAgdGhpcy5fcmVzdWx0ID0gcmVzdWx0O1xuICAgIH1cblxuICAgIHB1YmxpYyBmb3JtYXQgKCk6IEZvcm1hdHRlZENvbW1hbmQge1xuICAgICAgICBjb25zdCBmb3JtYXR0ZWRDb21tYW5kOiBGb3JtYXR0ZWRDb21tYW5kID0geyB0eXBlOiB0aGlzLl9jb21tYW5kLnR5cGUsIGFjdGlvbklkOiB0aGlzLl9jb21tYW5kLmFjdGlvbklkIH07XG5cbiAgICAgICAgaWYgKHRoaXMuX2NvbW1hbmQgaW5zdGFuY2VvZiBFeGVjdXRlU2VsZWN0b3JDb21tYW5kKVxuICAgICAgICAgICAgZm9ybWF0dGVkQ29tbWFuZC5zZWxlY3RvciA9IHRoaXMuX3ByZXBhcmVTZWxlY3Rvcih0aGlzLl9jb21tYW5kLCAnc2VsZWN0b3InKTtcbiAgICAgICAgZWxzZSBpZiAodGhpcy5fY29tbWFuZCBpbnN0YW5jZW9mIEV4ZWN1dGVDbGllbnRGdW5jdGlvbkNvbW1hbmQpXG4gICAgICAgICAgICBmb3JtYXR0ZWRDb21tYW5kLmNsaWVudEZuID0gdGhpcy5fcHJlcGFyZUNsaWVudEZ1bmN0aW9uKHRoaXMuX2NvbW1hbmQpO1xuICAgICAgICBlbHNlIGlmICh0aGlzLl9jb21tYW5kIGluc3RhbmNlb2YgVXNlUm9sZUNvbW1hbmQpXG4gICAgICAgICAgICBmb3JtYXR0ZWRDb21tYW5kLnJvbGUgPSB0aGlzLl9wcmVwYXJlUm9sZSh0aGlzLl9jb21tYW5kKTtcbiAgICAgICAgZWxzZSBpZiAodGhpcy5fY29tbWFuZCBpbnN0YW5jZW9mIE5hdmlnYXRlVG9Db21tYW5kKVxuICAgICAgICAgICAgZm9ybWF0dGVkQ29tbWFuZC51cmwgPSB0aGlzLl9wcmVwYXJlVXJsKHRoaXMuX2NvbW1hbmQpO1xuICAgICAgICBlbHNlIGlmICh0aGlzLl9jb21tYW5kIGluc3RhbmNlb2YgU2V0TmF0aXZlRGlhbG9nSGFuZGxlckNvbW1hbmQpXG4gICAgICAgICAgICBmb3JtYXR0ZWRDb21tYW5kLmRpYWxvZ0hhbmRsZXIgPSB0aGlzLl9wcmVwYXJlRGlhbG9nSGFuZGxlcih0aGlzLl9jb21tYW5kKTtcbiAgICAgICAgZWxzZVxuICAgICAgICAgICAgdGhpcy5fYXNzaWduUHJvcGVydGllcyh0aGlzLl9jb21tYW5kLCBmb3JtYXR0ZWRDb21tYW5kKTtcblxuICAgICAgICB0aGlzLl9tYXNrQ29uZmlkZW50aWFsSW5mbyhmb3JtYXR0ZWRDb21tYW5kKTtcblxuICAgICAgICByZXR1cm4gZm9ybWF0dGVkQ29tbWFuZDtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9tYXNrQ29uZmlkZW50aWFsSW5mbyAoY29tbWFuZDogRm9ybWF0dGVkQ29tbWFuZCk6IHZvaWQge1xuICAgICAgICBpZiAoIShjb21tYW5kLm9wdGlvbnMgYXMgYW55KT8uY29uZmlkZW50aWFsKVxuICAgICAgICAgICAgcmV0dXJuO1xuXG4gICAgICAgIGlmICh0aGlzLl9jb21tYW5kIGluc3RhbmNlb2YgVHlwZVRleHRDb21tYW5kKVxuICAgICAgICAgICAgY29tbWFuZC50ZXh0ID0gQ09ORklERU5USUFMX0lORk9fUExBQ0VIT0xERVI7XG4gICAgICAgIGVsc2UgaWYgKHRoaXMuX2NvbW1hbmQgaW5zdGFuY2VvZiBQcmVzc0tleUNvbW1hbmQpXG4gICAgICAgICAgICBjb21tYW5kLmtleXMgPSBDT05GSURFTlRJQUxfSU5GT19QTEFDRUhPTERFUjtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9nZXRFbGVtZW50QnlQcm9wZXJ0eU5hbWUgKHByb3BlcnR5TmFtZTogc3RyaW5nKTogSFRNTEVsZW1lbnQge1xuICAgICAgICB0aGlzLl9lbnN1cmVTZWxlY3RvckVsZW1lbnRzKCk7XG5cbiAgICAgICAgc3dpdGNoIChwcm9wZXJ0eU5hbWUpIHtcbiAgICAgICAgICAgIGNhc2UgJ3NlbGVjdG9yJzpcbiAgICAgICAgICAgIGNhc2UgJ3N0YXJ0U2VsZWN0b3InOlxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9lbGVtZW50c1swXTtcbiAgICAgICAgICAgIGNhc2UgJ2VuZFNlbGVjdG9yJzpcbiAgICAgICAgICAgIGNhc2UgJ2Rlc3RpbmF0aW9uU2VsZWN0b3InOlxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9lbGVtZW50c1sxXTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0aGlzLl9lbGVtZW50c1swXTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9wcmVwYXJlU2VsZWN0b3IgKGNvbW1hbmQ6IEV4ZWN1dGVTZWxlY3RvckNvbW1hbmQsIHByb3BlcnR5TmFtZTogc3RyaW5nKTogU2VsZWN0b3JJbmZvIHtcbiAgICAgICAgY29uc3Qgc2VsZWN0b3JDaGFpbiA9IGNvbW1hbmQuYXBpRm5DaGFpbiBhcyBzdHJpbmdbXTtcbiAgICAgICAgY29uc3QgZXhwcmVzc2lvbiAgICA9IHNlbGVjdG9yQ2hhaW4uam9pbignJyk7XG5cbiAgICAgICAgY29uc3QgcmVzdWx0OiBTZWxlY3RvckluZm8gPSB7IGV4cHJlc3Npb24gfTtcblxuICAgICAgICBsZXQgZWxlbWVudCA9IG51bGw7XG5cbiAgICAgICAgaWYgKHRoaXMuX3Jlc3VsdClcbiAgICAgICAgICAgIGVsZW1lbnQgPSB0aGlzLl9nZXRFbGVtZW50QnlQcm9wZXJ0eU5hbWUocHJvcGVydHlOYW1lKTtcblxuICAgICAgICBpZiAoZWxlbWVudClcbiAgICAgICAgICAgIHJlc3VsdC5lbGVtZW50ID0gZWxlbWVudDtcblxuICAgICAgICBpZiAoY29tbWFuZC50aW1lb3V0KVxuICAgICAgICAgICAgcmVzdWx0LnRpbWVvdXQgPSBjb21tYW5kLnRpbWVvdXQgYXMgbnVtYmVyO1xuXG4gICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfcHJlcGFyZUNsaWVudEZ1bmN0aW9uIChjb21tYW5kOiBFeGVjdXRlQ2xpZW50RnVuY3Rpb25Db21tYW5kKTogb2JqZWN0IHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIGNvZGU6IGNvbW1hbmQuZm5Db2RlLFxuICAgICAgICAgICAgYXJnczogY29tbWFuZC5hcmdzWzBdLFxuICAgICAgICB9O1xuICAgIH1cblxuICAgIHByaXZhdGUgX3ByZXBhcmVEaWFsb2dIYW5kbGVyIChjb21tYW5kOiBTZXROYXRpdmVEaWFsb2dIYW5kbGVyQ29tbWFuZCk6IG9iamVjdCB7XG4gICAgICAgIHJldHVybiB0aGlzLl9wcmVwYXJlQ2xpZW50RnVuY3Rpb24oY29tbWFuZC5kaWFsb2dIYW5kbGVyKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9wcmVwYXJlUm9sZSAoY29tbWFuZDogVXNlUm9sZUNvbW1hbmQpOiBvYmplY3Qge1xuICAgICAgICBjb25zdCB7IGxvZ2luVXJsLCBvcHRzLCBwaGFzZSB9ID0gY29tbWFuZC5yb2xlO1xuXG4gICAgICAgIHJldHVybiB7IGxvZ2luVXJsLCBvcHRpb25zOiBvcHRzLCBwaGFzZSB9O1xuICAgIH1cblxuICAgIHByaXZhdGUgX3ByZXBhcmVVcmwgKGNvbW1hbmQ6IE5hdmlnYXRlVG9Db21tYW5kKTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIGNvbW1hbmQudXJsO1xuICAgIH1cblxuICAgIHByaXZhdGUgX2ZpbHRlck5vdFJlcG9ydGVkUHJvcGVydGllcyAocHJvcGVydGllczogc3RyaW5nW10sIGNvbW1hbmRUeXBlOiBzdHJpbmcpOiBzdHJpbmdbXSB7XG4gICAgICAgIGlmIChjb21tYW5kVHlwZSAhPT0gQ29tbWFuZFR5cGUuYXNzZXJ0aW9uKVxuICAgICAgICAgICAgcmV0dXJuIHByb3BlcnRpZXM7XG5cbiAgICAgICAgcmV0dXJuIHByb3BlcnRpZXMuZmlsdGVyKHByb3AgPT4gIUFzc2VydGlvbkNvbW1hbmQuTk9UX1JFUE9SVEVEX1BST1BFUlRJRVMuaW5jbHVkZXMocHJvcCkpO1xuICAgIH1cblxuICAgIHByaXZhdGUgX2Fzc2lnblByb3BlcnRpZXMgKGNvbW1hbmQ6IENvbW1hbmRCYXNlLCBmb3JtYXR0ZWRDb21tYW5kOiBGb3JtYXR0ZWRDb21tYW5kKTogdm9pZCB7XG4gICAgICAgIGlmICghdGhpcy5fY29tbWFuZC5fZ2V0QXNzaWduYWJsZVByb3BlcnRpZXMpXG4gICAgICAgICAgICByZXR1cm47XG5cbiAgICAgICAgbGV0IHNvdXJjZVByb3BlcnRpZXMgPSB0aGlzLl9jb21tYW5kLl9nZXRBc3NpZ25hYmxlUHJvcGVydGllcygpLm1hcChwcm9wID0+IHByb3AubmFtZSk7XG5cbiAgICAgICAgc291cmNlUHJvcGVydGllcyA9IHRoaXMuX2ZpbHRlck5vdFJlcG9ydGVkUHJvcGVydGllcyhzb3VyY2VQcm9wZXJ0aWVzLCB0aGlzLl9jb21tYW5kLnR5cGUpO1xuXG4gICAgICAgIHNvdXJjZVByb3BlcnRpZXMuZm9yRWFjaCgoa2V5OiBzdHJpbmcpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHByb3BlcnR5ID0gdGhpcy5fY29tbWFuZFtrZXldO1xuXG4gICAgICAgICAgICBpZiAocHJvcGVydHkgaW5zdGFuY2VvZiBFeGVjdXRlU2VsZWN0b3JDb21tYW5kKVxuICAgICAgICAgICAgICAgIGZvcm1hdHRlZENvbW1hbmRba2V5XSA9IHRoaXMuX3ByZXBhcmVTZWxlY3Rvcihwcm9wZXJ0eSwga2V5KTtcbiAgICAgICAgICAgIGVsc2UgaWYgKGlzQ29tbWFuZE9wdGlvbnMocHJvcGVydHkgYXMgb2JqZWN0KSkge1xuICAgICAgICAgICAgICAgIGNvbnN0IG1vZGlmaWVkT3B0aW9ucyA9IENvbW1hbmRGb3JtYXR0ZXIuX2dldE1vZGlmaWVkT3B0aW9ucyhwcm9wZXJ0eSBhcyBvYmplY3QpO1xuXG4gICAgICAgICAgICAgICAgaWYgKCFpc0VtcHR5KG1vZGlmaWVkT3B0aW9ucykpXG4gICAgICAgICAgICAgICAgICAgIGZvcm1hdHRlZENvbW1hbmRba2V5XSA9IG1vZGlmaWVkT3B0aW9ucztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2VcbiAgICAgICAgICAgICAgICBmb3JtYXR0ZWRDb21tYW5kW2tleV0gPSBwcm9wZXJ0eTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfZW5zdXJlU2VsZWN0b3JFbGVtZW50cyAoKTogdm9pZCB7XG4gICAgICAgIGlmICghdGhpcy5fcmVzdWx0IHx8IHRoaXMuX2VsZW1lbnRzLmxlbmd0aClcbiAgICAgICAgICAgIHJldHVybjtcblxuICAgICAgICBjb25zdCBkZWNvZGVkID0gY3JlYXRlUmVwbGljYXRvcihuZXcgU2VsZWN0b3JOb2RlVHJhbnNmb3JtKCkpLmRlY29kZSh0aGlzLl9yZXN1bHQpO1xuXG4gICAgICAgIHRoaXMuX2VsZW1lbnRzID0gQXJyYXkuaXNBcnJheShkZWNvZGVkKSA/IGRlY29kZWQgOiBbZGVjb2RlZF07XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzdGF0aWMgX2dldE1vZGlmaWVkT3B0aW9ucyAoY29tbWFuZE9wdGlvbnM6IG9iamVjdCk6IERpY3Rpb25hcnk8b2JqZWN0PiB8IG51bGwge1xuICAgICAgICBjb25zdCBjb25zdHJ1Y3RvciAgICA9IGNvbW1hbmRPcHRpb25zLmNvbnN0cnVjdG9yIGFzIE9iamVjdENvbnN0cnVjdG9yO1xuICAgICAgICBjb25zdCBkZWZhdWx0T3B0aW9ucyA9IG5ldyBjb25zdHJ1Y3RvcigpO1xuXG4gICAgICAgIHJldHVybiBkaWZmKGRlZmF1bHRPcHRpb25zIGFzIERpY3Rpb25hcnk8b2JqZWN0PiwgY29tbWFuZE9wdGlvbnMgYXMgRGljdGlvbmFyeTxvYmplY3Q+KTtcbiAgICB9XG59XG4iXX0=