"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const adapter_1 = require("../adapter");
const event_emitter_1 = __importDefault(require("../utils/event-emitter"));
const delay_1 = __importDefault(require("../utils/delay"));
const promise_1 = require("../utils/promise");
const automation_errors_1 = __importDefault(require("../errors/automation-errors"));
const errors_1 = require("../../shared/errors");
const elements_retriever_1 = __importDefault(require("../utils/elements-retriever"));
const MAX_DELAY_AFTER_EXECUTION = 2000;
const CHECK_ELEMENT_IN_AUTOMATIONS_INTERVAL = 250;
class ActionExecutor extends event_emitter_1.default {
    constructor(command, globalSelectorTimeout, testSpeed, executeSelectorFn) {
        var _a;
        super();
        this._command = command;
        this._targetElement = null;
        this._elements = [];
        this._globalSelectorTimeout = globalSelectorTimeout;
        this._executionStartTime = 0;
        this._executeSelectorFn = executeSelectorFn;
        // TODO: move it to the server
        // @ts-ignore
        if (command.options && !command.options.speed) // @ts-ignore
            command.options.speed = testSpeed;
        // TODO: and this
        // @ts-ignore
        this._commandSelectorTimeout = typeof ((_a = command.selector) === null || _a === void 0 ? void 0 : _a.timeout) === 'number' ? command.selector.timeout : globalSelectorTimeout;
    }
    _delayAfterExecution() {
        // @ts-ignore TODO
        if (!this._command.options || this._command.options.speed === 1)
            return adapter_1.adapter.PromiseCtor.resolve();
        // @ts-ignore TODO
        return delay_1.default((1 - this._command.options.speed) * MAX_DELAY_AFTER_EXECUTION);
    }
    _isExecutionTimeoutExpired() {
        return adapter_1.adapter.nativeMethods.dateNow() - this._executionStartTime >= this._commandSelectorTimeout;
    }
    _ensureCommandArguments() {
        const handler = ActionExecutor.ACTIONS_HANDLERS[this._command.type];
        if (!(handler === null || handler === void 0 ? void 0 : handler.ensureCmdArgs))
            return;
        handler.ensureCmdArgs(this._command);
    }
    _ensureCommandElements() {
        var _a;
        const elsRetriever = new elements_retriever_1.default(this._globalSelectorTimeout, this._executeSelectorFn);
        if (this._command.selector)
            // @ts-ignore TODO
            elsRetriever.push(this._command.selector);
        const additionalSelectorProps = (_a = ActionExecutor.ACTIONS_HANDLERS[this._command.type]) === null || _a === void 0 ? void 0 : _a.additionalSelectorProps;
        if (additionalSelectorProps) {
            for (const prop of additionalSelectorProps) {
                if (this._command[prop])
                    // @ts-ignore TODO
                    elsRetriever.push(this._command[prop], prop);
            }
        }
        return elsRetriever.getElements()
            .then(elements => {
            this._elements = elements;
        });
    }
    _ensureCommandElementsProperties() {
        const handler = ActionExecutor.ACTIONS_HANDLERS[this._command.type];
        if (!(handler === null || handler === void 0 ? void 0 : handler.ensureElsProps))
            return;
        handler.ensureElsProps(this._elements);
    }
    _ensureCommandOptions() {
        const opts = this._command.options;
        // @ts-ignore TODO
        if (this._elements.length && opts && 'offsetX' in opts && 'offsetY' in opts) { // @ts-ignore
            const { offsetX, offsetY } = adapter_1.adapter.getOffsetOptions(this._elements[0], opts.offsetX, opts.offsetY);
            // @ts-ignore TODO
            opts.offsetX = offsetX;
            // @ts-ignore TODO
            opts.offsetY = offsetY;
        }
    }
    _createAutomation() {
        const handler = ActionExecutor.ACTIONS_HANDLERS[this._command.type];
        if (!handler)
            throw new Error(`There is no handler for the "${this._command.type}" command.`);
        return handler.create(this._command, this._elements);
    }
    _runAction(strictElementCheck) {
        return this._ensureCommandElements()
            .then(() => this._ensureCommandElementsProperties())
            .then(() => {
            this._ensureCommandOptions();
            const automation = this._createAutomation();
            if (automation.TARGET_ELEMENT_FOUND_EVENT) {
                automation.on(automation.TARGET_ELEMENT_FOUND_EVENT, e => {
                    this._targetElement = e.element;
                    this.emit(ActionExecutor.EXECUTION_STARTED_EVENT);
                });
            }
            else
                this.emit(ActionExecutor.EXECUTION_STARTED_EVENT);
            return automation.run(strictElementCheck);
        });
    }
    _runRecursively() {
        let actionFinished = false;
        let strictElementCheck = true;
        return promise_1.whilst(() => !actionFinished, () => {
            return this._runAction(strictElementCheck)
                .then(() => {
                actionFinished = true;
            })
                .catch(err => {
                if (!this._isExecutionTimeoutExpired())
                    return delay_1.default(CHECK_ELEMENT_IN_AUTOMATIONS_INTERVAL);
                if (err.message === automation_errors_1.default.foundElementIsNotTarget) {
                    // If we can't get a target element via elementFromPoint but it's
                    // visible we click on the point where the element is located.
                    strictElementCheck = false;
                    return adapter_1.adapter.PromiseCtor.resolve();
                }
                throw err.message === automation_errors_1.default.elementIsInvisibleError ?
                    new errors_1.ActionElementIsInvisibleError() : err;
            });
        });
    }
    execute(barriers) {
        this._executionStartTime = adapter_1.adapter.nativeMethods.dateNow();
        try {
            // TODO: I think that this check is unnecessary here. It checks only a key sequence of the pressKey command.
            // This check can be moved to the server.
            this._ensureCommandArguments();
        }
        catch (err) {
            return adapter_1.adapter.PromiseCtor.reject(err);
        }
        this.emit(ActionExecutor.WAITING_FOR_ELEMENT_EVENT, this._commandSelectorTimeout);
        return this._runRecursively()
            .then(() => Promise.all([
            this._delayAfterExecution(),
            barriers.wait(),
        ]))
            .then(() => {
            const elements = [...this._elements];
            if (this._targetElement)
                elements[0] = this._targetElement;
            return elements;
        });
    }
}
exports.default = ActionExecutor;
ActionExecutor.EXECUTION_STARTED_EVENT = 'execution-started';
ActionExecutor.WAITING_FOR_ELEMENT_EVENT = 'waiting-for-elements';
ActionExecutor.ACTIONS_HANDLERS = {};
module.exports = exports.default;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWN0aW9uLWV4ZWN1dG9yLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL3NoYXJlZC9hY3Rpb25zL2FjdGlvbi1leGVjdXRvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLHdDQUFxQztBQUNyQywyRUFBa0Q7QUFFbEQsMkRBQW1DO0FBQ25DLDhDQUEwQztBQUcxQyxvRkFBaUU7QUFDakUsZ0RBQW9FO0FBRXBFLHFGQUE0RDtBQUk1RCxNQUFNLHlCQUF5QixHQUFlLElBQUksQ0FBQztBQUNuRCxNQUFNLHFDQUFxQyxHQUFHLEdBQUcsQ0FBQztBQUVsRCxNQUFxQixjQUFrQixTQUFRLHVCQUFZO0lBYXZELFlBQW9CLE9BQTBCLEVBQUUscUJBQTZCLEVBQUUsU0FBaUIsRUFBRSxpQkFBdUM7O1FBQ3JJLEtBQUssRUFBRSxDQUFDO1FBRVIsSUFBSSxDQUFDLFFBQVEsR0FBUyxPQUFPLENBQUM7UUFDOUIsSUFBSSxDQUFDLGNBQWMsR0FBRyxJQUFJLENBQUM7UUFDM0IsSUFBSSxDQUFDLFNBQVMsR0FBUSxFQUFFLENBQUM7UUFFekIsSUFBSSxDQUFDLHNCQUFzQixHQUFHLHFCQUFxQixDQUFDO1FBQ3BELElBQUksQ0FBQyxtQkFBbUIsR0FBTSxDQUFDLENBQUM7UUFDaEMsSUFBSSxDQUFDLGtCQUFrQixHQUFPLGlCQUFpQixDQUFDO1FBRWhELDhCQUE4QjtRQUM5QixhQUFhO1FBQ2IsSUFBSSxPQUFPLENBQUMsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxLQUFLLEVBQUUsYUFBYTtZQUN4RCxPQUFPLENBQUMsT0FBTyxDQUFDLEtBQUssR0FBRyxTQUFTLENBQUM7UUFFdEMsaUJBQWlCO1FBQ2pCLGFBQWE7UUFDYixJQUFJLENBQUMsdUJBQXVCLEdBQUcsY0FBTyxPQUFPLENBQUMsUUFBUSwwQ0FBRSxPQUFPLENBQUEsS0FBSyxRQUFRLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxRQUFRLENB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QUF5QztZQUN6QyxJQUFJLENBQUMsdUJBQXVCLEVBQUUsQ0FBQztTQUNsQztRQUNELE9BQU8sR0FBRyxFQUFFO1lBQ1IsT0FBTyxpQkFBTyxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7U0FDMUM7UUFFRCxJQUFJLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyx5QkFBeUIsRUFBRSxJQUFJLENBQUMsdUJBQXVCLENBQUMsQ0FBQztRQUVsRixPQUFPLElBQUksQ0FBQyxlQUFlLEVBQUU7YUFDeEIsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUM7WUFDcEIsSUFBSSxDQUFDLG9CQUFvQixFQUFFO1lBQzNCLFFBQVEsQ0FBQyxJQUFJLEVBQUU7U0FDbEIsQ0FBQyxDQUFDO2FBQ0YsSUFBSSxDQUFDLEdBQUcsRUFBRTtZQUNQLE1BQU0sUUFBUSxHQUFHLENBQUMsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7WUFFckMsSUFBSSxJQUFJLENBQUMsY0FBYztnQkFDbkIsUUFBUSxDQUFDLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUM7WUFFdEMsT0FBTyxRQUFRLENBQUM7UUFDcEIsQ0FBQyxDQUFDLENBQUM7SUFDWCxDQUFDOztBQTNMTCxpQ0E0TEM7QUEzTDBCLHNDQUF1QixHQUFHLG1CQUFtQixDQUFDO0FBQzlDLHdDQUF5QixHQUFHLHNCQUFzQixDQUFDO0FBQ25ELCtCQUFnQixHQUFrQyxFQUFFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBhZGFwdGVyIH0gZnJvbSAnLi4vYWRhcHRlcic7XG5pbXBvcnQgRXZlbnRFbWl0dGVyIGZyb20gJy4uL3V0aWxzL2V2ZW50LWVtaXR0ZXInO1xuaW1wb3J0IENvbXBsZXhCYXJyaWVyIGZyb20gJy4uL2JhcnJpZXJzL2NvbXBsZXgtYmFycmllcic7XG5pbXBvcnQgZGVsYXkgZnJvbSAnLi4vdXRpbHMvZGVsYXknO1xuaW1wb3J0IHsgd2hpbHN0IH0gZnJvbSAnLi4vdXRpbHMvcHJvbWlzZSc7XG5pbXBvcnQgeyBBY3Rpb25Db21tYW5kQmFzZSB9IGZyb20gJy4uLy4uL3Rlc3QtcnVuL2NvbW1hbmRzL2Jhc2UnO1xuaW1wb3J0IHsgRGljdGlvbmFyeSB9IGZyb20gJy4uLy4uL2NvbmZpZ3VyYXRpb24vaW50ZXJmYWNlcyc7XG5pbXBvcnQgQVVUT01BVElPTl9FUlJPUl9UWVBFUyBmcm9tICcuLi9lcnJvcnMvYXV0b21hdGlvbi1lcnJvcnMnO1xuaW1wb3J0IHsgQWN0aW9uRWxlbWVudElzSW52aXNpYmxlRXJyb3IgfSBmcm9tICcuLi8uLi9zaGFyZWQvZXJyb3JzJztcbmltcG9ydCB7IEV4ZWN1dGVTZWxlY3RvckZuIH0gZnJvbSAnLi4vdHlwZXMnO1xuaW1wb3J0IEVsZW1lbnRzUmV0cmlldmVyIGZyb20gJy4uL3V0aWxzL2VsZW1lbnRzLXJldHJpZXZlcic7XG5pbXBvcnQgeyBBdXRvbWF0aW9uLCBBdXRvbWF0aW9uSGFuZGxlciB9IGZyb20gJy4vdHlwZXMnO1xuXG5cbmNvbnN0IE1BWF9ERUxBWV9BRlRFUl9FWEVDVVRJT04gICAgICAgICAgICAgPSAyMDAwO1xuY29uc3QgQ0hFQ0tfRUxFTUVOVF9JTl9BVVRPTUFUSU9OU19JTlRFUlZBTCA9IDI1MDtcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgQWN0aW9uRXhlY3V0b3I8VD4gZXh0ZW5kcyBFdmVudEVtaXR0ZXIge1xuICAgIHB1YmxpYyBzdGF0aWMgcmVhZG9ubHkgRVhFQ1VUSU9OX1NUQVJURURfRVZFTlQgPSAnZXhlY3V0aW9uLXN0YXJ0ZWQnO1xuICAgIHB1YmxpYyBzdGF0aWMgcmVhZG9ubHkgV0FJVElOR19GT1JfRUxFTUVOVF9FVkVOVCA9ICd3YWl0aW5nLWZvci1lbGVtZW50cyc7XG4gICAgcHVibGljIHN0YXRpYyByZWFkb25seSBBQ1RJT05TX0hBTkRMRVJTOiBEaWN0aW9uYXJ5PEF1dG9tYXRpb25IYW5kbGVyPiA9IHt9O1xuXG4gICAgcHJpdmF0ZSByZWFkb25seSBfY29tbWFuZDogQWN0aW9uQ29tbWFuZEJhc2U7XG4gICAgcHJpdmF0ZSByZWFkb25seSBfZ2xvYmFsU2VsZWN0b3JUaW1lb3V0OiBudW1iZXI7XG4gICAgcHJpdmF0ZSByZWFkb25seSBfY29tbWFuZFNlbGVjdG9yVGltZW91dDogbnVtYmVyO1xuICAgIHByaXZhdGUgcmVhZG9ubHkgX2V4ZWN1dGVTZWxlY3RvckZuOiBFeGVjdXRlU2VsZWN0b3JGbjxUPjtcbiAgICBwcml2YXRlIF9lbGVtZW50czogVFtdO1xuICAgIHByaXZhdGUgX2V4ZWN1dGlvblN0YXJ0VGltZTogbnVtYmVyO1xuICAgIHByaXZhdGUgX3RhcmdldEVsZW1lbnQ6IFQgfCBudWxsO1xuXG4gICAgcHVibGljIGNvbnN0cnVjdG9yIChjb21tYW5kOiBBY3Rpb25Db21tYW5kQmFzZSwgZ2xvYmFsU2VsZWN0b3JUaW1lb3V0OiBudW1iZXIsIHRlc3RTcGVlZDogbnVtYmVyLCBleGVjdXRlU2VsZWN0b3JGbjogRXhlY3V0ZVNlbGVjdG9yRm48VD4pIHtcbiAgICAgICAgc3VwZXIoKTtcblxuICAgICAgICB0aGlzLl9jb21tYW5kICAgICAgID0gY29tbWFuZDtcbiAgICAgICAgdGhpcy5fdGFyZ2V0RWxlbWVudCA9IG51bGw7XG4gICAgICAgIHRoaXMuX2VsZW1lbnRzICAgICAgPSBbXTtcblxuICAgICAgICB0aGlzLl9nbG9iYWxTZWxlY3RvclRpbWVvdXQgPSBnbG9iYWxTZWxlY3RvclRpbWVvdXQ7XG4gICAgICAgIHRoaXMuX2V4ZWN1dGlvblN0YXJ0VGltZSAgICA9IDA7XG4gICAgICAgIHRoaXMuX2V4ZWN1dGVTZWxlY3RvckZuICAgICA9IGV4ZWN1dGVTZWxlY3RvckZuO1xuXG4gICAgICAgIC8vIFRPRE86IG1vdmUgaXQgdG8gdGhlIHNlcnZlclxuICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgIGlmIChjb21tYW5kLm9wdGlvbnMgJiYgIWNvbW1hbmQub3B0aW9ucy5zcGVlZCkgLy8gQHRzLWlnbm9yZVxuICAgICAgICAgICAgY29tbWFuZC5vcHRpb25zLnNwZWVkID0gdGVzdFNwZWVkO1xuXG4gICAgICAgIC8vIFRPRE86IGFuZCB0aGlzXG4gICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgdGhpcy5fY29tbWFuZFNlbGVjdG9yVGltZW91dCA9IHR5cGVvZiBjb21tYW5kLnNlbGVjdG9yPy50aW1lb3V0ID09PSAnbnVtYmVyJyA/IGNvbW1hbmQuc2VsZWN0b3IudGltZW91dCA6IGdsb2JhbFNlbGVjdG9yVGltZW91dDtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9kZWxheUFmdGVyRXhlY3V0aW9uICgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgLy8gQHRzLWlnbm9yZSBUT0RPXG4gICAgICAgIGlmICghdGhpcy5fY29tbWFuZC5vcHRpb25zIHx8IHRoaXMuX2NvbW1hbmQub3B0aW9ucy5zcGVlZCA9PT0gMSlcbiAgICAgICAgICAgIHJldHVybiBhZGFwdGVyLlByb21pc2VDdG9yLnJlc29sdmUoKTtcblxuICAgICAgICAvLyBAdHMtaWdub3JlIFRPRE9cbiAgICAgICAgcmV0dXJuIGRlbGF5KCgxIC0gdGhpcy5fY29tbWFuZC5vcHRpb25zLnNwZWVkKSAqIE1BWF9ERUxBWV9BRlRFUl9FWEVDVVRJT04pO1xuICAgIH1cblxuICAgIHByaXZhdGUgX2lzRXhlY3V0aW9uVGltZW91dEV4cGlyZWQgKCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gYWRhcHRlci5uYXRpdmVNZXRob2RzLmRhdGVOb3coKSAtIHRoaXMuX2V4ZWN1dGlvblN0YXJ0VGltZSA+PSB0aGlzLl9jb21tYW5kU2VsZWN0b3JUaW1lb3V0O1xuICAgIH1cblxuICAgIHByaXZhdGUgX2Vuc3VyZUNvbW1hbmRBcmd1bWVudHMgKCk6IHZvaWQge1xuICAgICAgICBjb25zdCBoYW5kbGVyID0gQWN0aW9uRXhlY3V0b3IuQUNUSU9OU19IQU5ETEVSU1t0aGlzLl9jb21tYW5kLnR5cGVdO1xuXG4gICAgICAgIGlmICghaGFuZGxlcj8uZW5zdXJlQ21kQXJncylcbiAgICAgICAgICAgIHJldHVybjtcblxuICAgICAgICBoYW5kbGVyLmVuc3VyZUNtZEFyZ3ModGhpcy5fY29tbWFuZCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfZW5zdXJlQ29tbWFuZEVsZW1lbnRzICgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgY29uc3QgZWxzUmV0cmlldmVyID0gbmV3IEVsZW1lbnRzUmV0cmlldmVyKHRoaXMuX2dsb2JhbFNlbGVjdG9yVGltZW91dCwgdGhpcy5fZXhlY3V0ZVNlbGVjdG9yRm4pO1xuXG4gICAgICAgIGlmICh0aGlzLl9jb21tYW5kLnNlbGVjdG9yKVxuICAgICAgICAgICAgLy8gQHRzLWlnbm9yZSBUT0RPXG4gICAgICAgICAgICBlbHNSZXRyaWV2ZXIucHVzaCh0aGlzLl9jb21tYW5kLnNlbGVjdG9yKTtcblxuICAgICAgICBjb25zdCBhZGRpdGlvbmFsU2VsZWN0b3JQcm9wcyA9IEFjdGlvbkV4ZWN1dG9yLkFDVElPTlNfSEFORExFUlNbdGhpcy5fY29tbWFuZC50eXBlXT8uYWRkaXRpb25hbFNlbGVjdG9yUHJvcHM7XG5cbiAgICAgICAgaWYgKGFkZGl0aW9uYWxTZWxlY3RvclByb3BzKSB7XG4gICAgICAgICAgICBmb3IgKGNvbnN0IHByb3Agb2YgYWRkaXRpb25hbFNlbGVjdG9yUHJvcHMpIHtcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5fY29tbWFuZFtwcm9wXSlcbiAgICAgICAgICAgICAgICAgICAgLy8gQHRzLWlnbm9yZSBUT0RPXG4gICAgICAgICAgICAgICAgICAgIGVsc1JldHJpZXZlci5wdXNoKHRoaXMuX2NvbW1hbmRbcHJvcF0sIHByb3ApO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGVsc1JldHJpZXZlci5nZXRFbGVtZW50cygpXG4gICAgICAgICAgICAudGhlbihlbGVtZW50cyA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5fZWxlbWVudHMgPSBlbGVtZW50cztcbiAgICAgICAgICAgIH0pO1xuICAgIH1cblxuICAgIHByaXZhdGUgX2Vuc3VyZUNvbW1hbmRFbGVtZW50c1Byb3BlcnRpZXMgKCk6IHZvaWQge1xuICAgICAgICBjb25zdCBoYW5kbGVyID0gQWN0aW9uRXhlY3V0b3IuQUNUSU9OU19IQU5ETEVSU1t0aGlzLl9jb21tYW5kLnR5cGVdO1xuXG4gICAgICAgIGlmICghaGFuZGxlcj8uZW5zdXJlRWxzUHJvcHMpXG4gICAgICAgICAgICByZXR1cm47XG5cbiAgICAgICAgaGFuZGxlci5lbnN1cmVFbHNQcm9wcyh0aGlzLl9lbGVtZW50cyk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfZW5zdXJlQ29tbWFuZE9wdGlvbnMgKCk6IHZvaWQge1xuICAgICAgICBjb25zdCBvcHRzID0gdGhpcy5fY29tbWFuZC5vcHRpb25zO1xuXG4gICAgICAgIC8vIEB0cy1pZ25vcmUgVE9ET1xuICAgICAgICBpZiAodGhpcy5fZWxlbWVudHMubGVuZ3RoICYmIG9wdHMgJiYgJ29mZnNldFgnIGluIG9wdHMgJiYgJ29mZnNldFknIGluIG9wdHMpIHsgLy8gQHRzLWlnbm9yZVxuICAgICAgICAgICAgY29uc3QgeyBvZmZzZXRYLCBvZmZzZXRZIH0gPSBhZGFwdGVyLmdldE9mZnNldE9wdGlvbnModGhpcy5fZWxlbWVudHNbMF0sIG9wdHMub2Zmc2V0WCwgb3B0cy5vZmZzZXRZKTtcblxuICAgICAgICAgICAgLy8gQHRzLWlnbm9yZSBUT0RPXG4gICAgICAgICAgICBvcHRzLm9mZnNldFggPSBvZmZzZXRYO1xuICAgICAgICAgICAgLy8gQHRzLWlnbm9yZSBUT0RPXG4gICAgICAgICAgICBvcHRzLm9mZnNldFkgPSBvZmZzZXRZO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfY3JlYXRlQXV0b21hdGlvbiAoKTogQXV0b21hdGlvbiB7XG4gICAgICAgIGNvbnN0IGhhbmRsZXIgPSBBY3Rpb25FeGVjdXRvci5BQ1RJT05TX0hBTkRMRVJTW3RoaXMuX2NvbW1hbmQudHlwZV07XG5cbiAgICAgICAgaWYgKCFoYW5kbGVyKVxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBUaGVyZSBpcyBubyBoYW5kbGVyIGZvciB0aGUgXCIke3RoaXMuX2NvbW1hbmQudHlwZX1cIiBjb21tYW5kLmApO1xuXG4gICAgICAgIHJldHVybiBoYW5kbGVyLmNyZWF0ZSh0aGlzLl9jb21tYW5kLCB0aGlzLl9lbGVtZW50cyk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfcnVuQWN0aW9uIChzdHJpY3RFbGVtZW50Q2hlY2s6IGJvb2xlYW4pOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2Vuc3VyZUNvbW1hbmRFbGVtZW50cygpXG4gICAgICAgICAgICAudGhlbigoKSA9PiB0aGlzLl9lbnN1cmVDb21tYW5kRWxlbWVudHNQcm9wZXJ0aWVzKCkpXG4gICAgICAgICAgICAudGhlbigoKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5fZW5zdXJlQ29tbWFuZE9wdGlvbnMoKTtcblxuICAgICAgICAgICAgICAgIGNvbnN0IGF1dG9tYXRpb24gPSB0aGlzLl9jcmVhdGVBdXRvbWF0aW9uKCk7XG5cbiAgICAgICAgICAgICAgICBpZiAoYXV0b21hdGlvbi5UQVJHRVRfRUxFTUVOVF9GT1VORF9FVkVOVCkge1xuICAgICAgICAgICAgICAgICAgICBhdXRvbWF0aW9uLm9uKGF1dG9tYXRpb24uVEFSR0VUX0VMRU1FTlRfRk9VTkRfRVZFTlQsIGUgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fdGFyZ2V0RWxlbWVudCA9IGUuZWxlbWVudDtcblxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5lbWl0KEFjdGlvbkV4ZWN1dG9yLkVYRUNVVElPTl9TVEFSVEVEX0VWRU5UKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2VcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5lbWl0KEFjdGlvbkV4ZWN1dG9yLkVYRUNVVElPTl9TVEFSVEVEX0VWRU5UKTtcblxuICAgICAgICAgICAgICAgIHJldHVybiBhdXRvbWF0aW9uLnJ1bihzdHJpY3RFbGVtZW50Q2hlY2spO1xuICAgICAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfcnVuUmVjdXJzaXZlbHkgKCk6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICBsZXQgYWN0aW9uRmluaXNoZWQgICAgID0gZmFsc2U7XG4gICAgICAgIGxldCBzdHJpY3RFbGVtZW50Q2hlY2sgPSB0cnVlO1xuXG4gICAgICAgIHJldHVybiB3aGlsc3QoKCkgPT4gIWFjdGlvbkZpbmlzaGVkLCAoKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5fcnVuQWN0aW9uKHN0cmljdEVsZW1lbnRDaGVjaylcbiAgICAgICAgICAgICAgICAudGhlbigoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGFjdGlvbkZpbmlzaGVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIC5jYXRjaChlcnIgPT4ge1xuICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuX2lzRXhlY3V0aW9uVGltZW91dEV4cGlyZWQoKSlcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBkZWxheShDSEVDS19FTEVNRU5UX0lOX0FVVE9NQVRJT05TX0lOVEVSVkFMKTtcblxuICAgICAgICAgICAgICAgICAgICBpZiAoZXJyLm1lc3NhZ2UgPT09IEFVVE9NQVRJT05fRVJST1JfVFlQRVMuZm91bmRFbGVtZW50SXNOb3RUYXJnZXQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIElmIHdlIGNhbid0IGdldCBhIHRhcmdldCBlbGVtZW50IHZpYSBlbGVtZW50RnJvbVBvaW50IGJ1dCBpdCdzXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyB2aXNpYmxlIHdlIGNsaWNrIG9uIHRoZSBwb2ludCB3aGVyZSB0aGUgZWxlbWVudCBpcyBsb2NhdGVkLlxuICAgICAgICAgICAgICAgICAgICAgICAgc3RyaWN0RWxlbWVudENoZWNrID0gZmFsc2U7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBhZGFwdGVyLlByb21pc2VDdG9yLnJlc29sdmUoKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIHRocm93IGVyci5tZXNzYWdlID09PSBBVVRPTUFUSU9OX0VSUk9SX1RZUEVTLmVsZW1lbnRJc0ludmlzaWJsZUVycm9yID9cbiAgICAgICAgICAgICAgICAgICAgICAgIG5ldyBBY3Rpb25FbGVtZW50SXNJbnZpc2libGVFcnJvcigpIDogZXJyO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZXhlY3V0ZSAoYmFycmllcnM6IENvbXBsZXhCYXJyaWVyPGFueSwgYW55Pik6IFByb21pc2U8VFtdPiB7XG4gICAgICAgIHRoaXMuX2V4ZWN1dGlvblN0YXJ0VGltZSA9IGFkYXB0ZXIubmF0aXZlTWV0aG9kcy5kYXRlTm93KCk7XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIC8vIFRPRE86IEkgdGhpbmsgdGhhdCB0aGlzIGNoZWNrIGlzIHVubmVjZXNzYXJ5IGhlcmUuIEl0IGNoZWNrcyBvbmx5IGEga2V5IHNlcXVlbmNlIG9mIHRoZSBwcmVzc0tleSBjb21tYW5kLlxuICAgICAgICAgICAgLy8gVGhpcyBjaGVjayBjYW4gYmUgbW92ZWQgdG8gdGhlIHNlcnZlci5cbiAgICAgICAgICAgIHRoaXMuX2Vuc3VyZUNvbW1hbmRBcmd1bWVudHMoKTtcbiAgICAgICAgfVxuICAgICAgICBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgICByZXR1cm4gYWRhcHRlci5Qcm9taXNlQ3Rvci5yZWplY3QoZXJyKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuZW1pdChBY3Rpb25FeGVjdXRvci5XQUlUSU5HX0ZPUl9FTEVNRU5UX0VWRU5ULCB0aGlzLl9jb21tYW5kU2VsZWN0b3JUaW1lb3V0KTtcblxuICAgICAgICByZXR1cm4gdGhpcy5fcnVuUmVjdXJzaXZlbHkoKVxuICAgICAgICAgICAgLnRoZW4oKCkgPT4gUHJvbWlzZS5hbGwoW1xuICAgICAgICAgICAgICAgIHRoaXMuX2RlbGF5QWZ0ZXJFeGVjdXRpb24oKSxcbiAgICAgICAgICAgICAgICBiYXJyaWVycy53YWl0KCksXG4gICAgICAgICAgICBdKSlcbiAgICAgICAgICAgIC50aGVuKCgpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCBlbGVtZW50cyA9IFsuLi50aGlzLl9lbGVtZW50c107XG5cbiAgICAgICAgICAgICAgICBpZiAodGhpcy5fdGFyZ2V0RWxlbWVudClcbiAgICAgICAgICAgICAgICAgICAgZWxlbWVudHNbMF0gPSB0aGlzLl90YXJnZXRFbGVtZW50O1xuXG4gICAgICAgICAgICAgICAgcmV0dXJuIGVsZW1lbnRzO1xuICAgICAgICAgICAgfSk7XG4gICAgfVxufVxuIl19