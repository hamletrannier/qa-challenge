"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.getScrollableParents = exports.hasScroll = void 0;
const index_1 = __importDefault(require("./adapter/index"));
const axis_values_1 = __importDefault(require("../../../../shared/utils/values/axis-values"));
const SCROLLABLE_OVERFLOW_STYLE_RE = /auto|scroll/i;
const DEFAULT_IE_SCROLLABLE_OVERFLOW_STYLE_VALUE = 'visible';
function getScrollable(el) {
    const overflowX = index_1.default.style.get(el, 'overflowX');
    const overflowY = index_1.default.style.get(el, 'overflowY');
    let scrollableHorizontally = SCROLLABLE_OVERFLOW_STYLE_RE.test(overflowX);
    let scrollableVertically = SCROLLABLE_OVERFLOW_STYLE_RE.test(overflowY);
    // IE11 and MS Edge bug: There are two properties: overflow-x and overflow-y.
    // If one property is set so that the browser may show scrollbars (`auto` or `scroll`) and the second one is set to 'visible',
    // then the second one will work as if it had the 'auto' value.
    if (index_1.default.browser.isIE) {
        scrollableHorizontally = scrollableHorizontally || scrollableVertically && overflowX === DEFAULT_IE_SCROLLABLE_OVERFLOW_STYLE_VALUE;
        scrollableVertically = scrollableVertically || scrollableHorizontally && overflowY === DEFAULT_IE_SCROLLABLE_OVERFLOW_STYLE_VALUE;
    }
    return new axis_values_1.default(scrollableHorizontally, scrollableVertically);
}
function hasBodyScroll(el) {
    const overflowX = index_1.default.style.get(el, 'overflowX');
    const overflowY = index_1.default.style.get(el, 'overflowY');
    const scrollableHorizontally = SCROLLABLE_OVERFLOW_STYLE_RE.test(overflowX);
    const scrollableVertically = SCROLLABLE_OVERFLOW_STYLE_RE.test(overflowY);
    const documentElement = index_1.default.dom.findDocument(el).documentElement;
    let bodyScrollHeight = el.scrollHeight;
    if (index_1.default.browser.isChrome || index_1.default.browser.isFirefox) {
        const { top: bodyTop } = el.getBoundingClientRect();
        const { top: documentTop } = documentElement.getBoundingClientRect();
        bodyScrollHeight = bodyScrollHeight - documentTop + bodyTop;
    }
    return (scrollableHorizontally || scrollableVertically) &&
        bodyScrollHeight > documentElement.scrollHeight;
}
function hasHTMLElementScroll(el) {
    const overflowX = index_1.default.style.get(el, 'overflowX');
    const overflowY = index_1.default.style.get(el, 'overflowY');
    //T303226
    if (overflowX === 'hidden' && overflowY === 'hidden')
        return false;
    const hasHorizontalScroll = el.scrollHeight > el.clientHeight;
    const hasVerticalScroll = el.scrollWidth > el.clientWidth;
    if (hasHorizontalScroll || hasVerticalScroll)
        return true;
    //T174562 - wrong scrolling in iframes without src and others iframes
    const body = el.getElementsByTagName('body')[0];
    if (!body)
        return false;
    if (hasBodyScroll(body))
        return false;
    const clientWidth = Math.min(el.clientWidth, body.clientWidth);
    const clientHeight = Math.min(el.clientHeight, body.clientHeight);
    return body.scrollHeight > clientHeight || body.scrollWidth > clientWidth;
}
function hasScroll(el) {
    if (index_1.default.dom.isBodyElement(el))
        return hasBodyScroll(el);
    if (index_1.default.dom.isHtmlElement(el))
        return hasHTMLElementScroll(el);
    const scrollable = getScrollable(el);
    if (!scrollable.x && !scrollable.y)
        return false;
    const hasVerticalScroll = scrollable.y && el.scrollHeight > el.clientHeight;
    const hasHorizontalScroll = scrollable.x && el.scrollWidth > el.clientWidth;
    return hasHorizontalScroll || hasVerticalScroll;
}
exports.hasScroll = hasScroll;
function getScrollableParents(element) {
    const parentsArray = index_1.default.dom.getParents(element);
    if (index_1.default.dom.isElementInIframe(element)) {
        const iframe = index_1.default.dom.getIframeByElement(element);
        if (iframe) {
            const iFrameParents = index_1.default.dom.getParents(iframe);
            parentsArray.concat(iFrameParents);
        }
    }
    return index_1.default.nativeMethods.arrayFilter.call(parentsArray, hasScroll);
}
exports.getScrollableParents = getScrollableParents;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2Nyb2xsLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vc3JjL2NsaWVudC9jb3JlL3V0aWxzL3NoYXJlZC9zY3JvbGwudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsNERBQXNDO0FBQ3RDLDhGQUFxRTtBQUdyRSxNQUFNLDRCQUE0QixHQUFpQixjQUFjLENBQUM7QUFDbEUsTUFBTSwwQ0FBMEMsR0FBRyxTQUFTLENBQUM7QUFFN0QsU0FBUyxhQUFhLENBQUUsRUFBVztJQUMvQixNQUFNLFNBQVMsR0FBYyxlQUFPLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxFQUFFLEVBQUUsV0FBVyxDQUFXLENBQUM7SUFDMUUsTUFBTSxTQUFTLEdBQWMsZUFBTyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsRUFBRSxFQUFFLFdBQVcsQ0FBVyxDQUFDO0lBQzFFLElBQUksc0JBQXNCLEdBQUcsNEJBQTRCLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBQzFFLElBQUksb0JBQW9CLEdBQUssNEJBQTRCLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBRTFFLDZFQUE2RTtJQUM3RSw4SEFBOEg7SUFDOUgsK0RBQStEO0lBQy9ELElBQUksZUFBTyxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUU7UUFDdEIsc0JBQXNCLEdBQUcsc0JBQXNCLElBQUksb0JBQW9CLElBQUksU0FBUyxLQUFLLDBDQUEwQyxDQUFDO1FBQ3BJLG9CQUFvQixHQUFLLG9CQUFvQixJQUFJLHNCQUFzQixJQUFJLFNBQVMsS0FBSywwQ0FBMEMsQ0FBQztLQUN2STtJQUVELE9BQU8sSUFBSSxxQkFBVSxDQUFDLHNCQUFzQixFQUFFLG9CQUFvQixDQUFDLENBQUM7QUFDeEUsQ0FBQztBQUVELFNBQVMsYUFBYSxDQUFFLEVBQW1CO0lBQ3ZDLE1BQU0sU0FBUyxHQUFnQixlQUFPLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxFQUFFLEVB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SUFFckMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUM5QixPQUFPLEtBQUssQ0FBQztJQUVqQixNQUFNLGlCQUFpQixHQUFLLFVBQVUsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDLFlBQVksR0FBRyxFQUFFLENBQUMsWUFBWSxDQUFDO0lBQzlFLE1BQU0sbUJBQW1CLEdBQUcsVUFBVSxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUMsV0FBVyxHQUFHLEVBQUUsQ0FBQyxXQUFXLENBQUM7SUFFNUUsT0FBTyxtQkFBbUIsSUFBSSxpQkFBaUIsQ0FBQztBQUNwRCxDQUFDO0FBaEJELDhCQWdCQztBQUVELFNBQWdCLG9CQUFvQixDQUFFLE9BQWdCO0lBQ2xELE1BQU0sWUFBWSxHQUFHLGVBQU8sQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBRXJELElBQUksZUFBTyxDQUFDLEdBQUcsQ0FBQyxpQkFBaUIsQ0FBQyxPQUFPLENBQUMsRUFBRTtRQUN4QyxNQUFNLE1BQU0sR0FBRyxlQUFPLENBQUMsR0FBRyxDQUFDLGtCQUFrQixDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBRXZELElBQUksTUFBTSxFQUFFO1lBQ1IsTUFBTSxhQUFhLEdBQUcsZUFBTyxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLENBQUM7WUFFckQsWUFBWSxDQUFDLE1BQU0sQ0FBQyxhQUFhLENBQUMsQ0FBQztTQUN0QztLQUNKO0lBRUQsT0FBTyxlQUFPLENBQUMsYUFBYSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsWUFBWSxFQUFFLFNBQVMsQ0FBQyxDQUFDO0FBQzNFLENBQUM7QUFkRCxvREFjQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBhZGFwdGVyIGZyb20gJy4vYWRhcHRlci9pbmRleCc7XG5pbXBvcnQgQXhpc1ZhbHVlcyBmcm9tICcuLi8uLi8uLi8uLi9zaGFyZWQvdXRpbHMvdmFsdWVzL2F4aXMtdmFsdWVzJztcblxuXG5jb25zdCBTQ1JPTExBQkxFX09WRVJGTE9XX1NUWUxFX1JFICAgICAgICAgICAgICAgPSAvYXV0b3xzY3JvbGwvaTtcbmNvbnN0IERFRkFVTFRfSUVfU0NST0xMQUJMRV9PVkVSRkxPV19TVFlMRV9WQUxVRSA9ICd2aXNpYmxlJztcblxuZnVuY3Rpb24gZ2V0U2Nyb2xsYWJsZSAoZWw6IEVsZW1lbnQpOiBBeGlzVmFsdWVzPGJvb2xlYW4+IHtcbiAgICBjb25zdCBvdmVyZmxvd1ggICAgICAgICAgICA9IGFkYXB0ZXIuc3R5bGUuZ2V0KGVsLCAnb3ZlcmZsb3dYJykgYXMgc3RyaW5nO1xuICAgIGNvbnN0IG92ZXJmbG93WSAgICAgICAgICAgID0gYWRhcHRlci5zdHlsZS5nZXQoZWwsICdvdmVyZmxvd1knKSBhcyBzdHJpbmc7XG4gICAgbGV0IHNjcm9sbGFibGVIb3Jpem9udGFsbHkgPSBTQ1JPTExBQkxFX09WRVJGTE9XX1NUWUxFX1JFLnRlc3Qob3ZlcmZsb3dYKTtcbiAgICBsZXQgc2Nyb2xsYWJsZVZlcnRpY2FsbHkgICA9IFNDUk9MTEFCTEVfT1ZFUkZMT1dfU1RZTEVfUkUudGVzdChvdmVyZmxvd1kpO1xuXG4gICAgLy8gSUUxMSBhbmQgTVMgRWRnZSBidWc6IFRoZXJlIGFyZSB0d28gcHJvcGVydGllczogb3ZlcmZsb3cteCBhbmQgb3ZlcmZsb3cteS5cbiAgICAvLyBJZiBvbmUgcHJvcGVydHkgaXMgc2V0IHNvIHRoYXQgdGhlIGJyb3dzZXIgbWF5IHNob3cgc2Nyb2xsYmFycyAoYGF1dG9gIG9yIGBzY3JvbGxgKSBhbmQgdGhlIHNlY29uZCBvbmUgaXMgc2V0IHRvICd2aXNpYmxlJyxcbiAgICAvLyB0aGVuIHRoZSBzZWNvbmQgb25lIHdpbGwgd29yayBhcyBpZiBpdCBoYWQgdGhlICdhdXRvJyB2YWx1ZS5cbiAgICBpZiAoYWRhcHRlci5icm93c2VyLmlzSUUpIHtcbiAgICAgICAgc2Nyb2xsYWJsZUhvcml6b250YWxseSA9IHNjcm9sbGFibGVIb3Jpem9udGFsbHkgfHwgc2Nyb2xsYWJsZVZlcnRpY2FsbHkgJiYgb3ZlcmZsb3dYID09PSBERUZBVUxUX0lFX1NDUk9MTEFCTEVfT1ZFUkZMT1dfU1RZTEVfVkFMVUU7XG4gICAgICAgIHNjcm9sbGFibGVWZXJ0aWNhbGx5ICAgPSBzY3JvbGxhYmxlVmVydGljYWxseSB8fCBzY3JvbGxhYmxlSG9yaXpvbnRhbGx5ICYmIG92ZXJmbG93WSA9PT0gREVGQVVMVF9JRV9TQ1JPTExBQkxFX09WRVJGTE9XX1NUWUxFX1ZBTFVFO1xuICAgIH1cblxuICAgIHJldHVybiBuZXcgQXhpc1ZhbHVlcyhzY3JvbGxhYmxlSG9yaXpvbnRhbGx5LCBzY3JvbGxhYmxlVmVydGljYWxseSk7XG59XG5cbmZ1bmN0aW9uIGhhc0JvZHlTY3JvbGwgKGVsOiBIVE1MQm9keUVsZW1lbnQpOiBib29sZWFuIHtcbiAgICBjb25zdCBvdmVyZmxvd1ggICAgICAgICAgICAgID0gYWRhcHRlci5zdHlsZS5nZXQoZWwsICdvdmVyZmxvd1gnKSBhcyBzdHJpbmc7XG4gICAgY29uc3Qgb3ZlcmZsb3dZICAgICAgICAgICAgICA9IGFkYXB0ZXIuc3R5bGUuZ2V0KGVsLCAnb3ZlcmZsb3dZJykgYXMgc3RyaW5nO1xuICAgIGNvbnN0IHNjcm9sbGFibGVIb3Jpem9udGFsbHkgPSBTQ1JPTExBQkxFX09WRVJGTE9XX1NUWUxFX1JFLnRlc3Qob3ZlcmZsb3dYKTtcbiAgICBjb25zdCBzY3JvbGxhYmxlVmVydGljYWxseSAgID0gU0NST0xMQUJMRV9PVkVSRkxPV19TVFlMRV9SRS50ZXN0KG92ZXJmbG93WSk7XG5cbiAgICBjb25zdCBkb2N1bWVudEVsZW1lbnQgPSBhZGFwdGVyLmRvbS5maW5kRG9jdW1lbnQoZWwpLmRvY3VtZW50RWxlbWVudDtcblxuICAgIGxldCBib2R5U2Nyb2xsSGVpZ2h0ID0gZWwuc2Nyb2xsSGVpZ2h0O1xuXG4gICAgaWYgKGFkYXB0ZXIuYnJvd3Nlci5pc0Nocm9tZSB8fCBhZGFwdGVyLmJyb3dzZXIuaXNGaXJlZm94KSB7XG4gICAgICAgIGNvbnN0IHsgdG9wOiBib2R5VG9wIH0gICAgID0gZWwuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XG4gICAgICAgIGNvbnN0IHsgdG9wOiBkb2N1bWVudFRvcCB9ID0gZG9jdW1lbnRFbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpO1xuXG4gICAgICAgIGJvZHlTY3JvbGxIZWlnaHQgPSBib2R5U2Nyb2xsSGVpZ2h0IC0gZG9jdW1lbnRUb3AgKyBib2R5VG9wO1xuICAgIH1cblxuICAgIHJldHVybiAoc2Nyb2xsYWJsZUhvcml6b250YWxseSB8fCBzY3JvbGxhYmxlVmVydGljYWxseSkgJiZcbiAgICAgICAgYm9keVNjcm9sbEhlaWdodCA+IGRvY3VtZW50RWxlbWVudC5zY3JvbGxIZWlnaHQ7XG59XG5cbmZ1bmN0aW9uIGhhc0hUTUxFbGVtZW50U2Nyb2xsIChlbDogSFRNTEh0bWxFbGVtZW50KTogYm9vbGVhbiB7XG4gICAgY29uc3Qgb3ZlcmZsb3dYID0gYWRhcHRlci5zdHlsZS5nZXQoZWwsICdvdmVyZmxvd1gnKSBhcyBzdHJpbmc7XG4gICAgY29uc3Qgb3ZlcmZsb3dZID0gYWRhcHRlci5zdHlsZS5nZXQoZWwsICdvdmVyZmxvd1knKSBhcyBzdHJpbmc7XG5cbiAgICAvL1QzMDMyMjZcbiAgICBpZiAob3ZlcmZsb3dYID09PSAnaGlkZGVuJyAmJiBvdmVyZmxvd1kgPT09ICdoaWRkZW4nKVxuICAgICAgICByZXR1cm4gZmFsc2U7XG5cbiAgICBjb25zdCBoYXNIb3Jpem9udGFsU2Nyb2xsID0gZWwuc2Nyb2xsSGVpZ2h0ID4gZWwuY2xpZW50SGVpZ2h0O1xuICAgIGNvbnN0IGhhc1ZlcnRpY2FsU2Nyb2xsICAgPSBlbC5zY3JvbGxXaWR0aCA+IGVsLmNsaWVudFdpZHRoO1xuXG4gICAgaWYgKGhhc0hvcml6b250YWxTY3JvbGwgfHwgaGFzVmVydGljYWxTY3JvbGwpXG4gICAgICAgIHJldHVybiB0cnVlO1xuXG4gICAgLy9UMTc0NTYyIC0gd3Jvbmcgc2Nyb2xsaW5nIGluIGlmcmFtZXMgd2l0aG91dCBzcmMgYW5kIG90aGVycyBpZnJhbWVzXG4gICAgY29uc3QgYm9keSA9IGVsLmdldEVsZW1lbnRzQnlUYWdOYW1lKCdib2R5JylbMF07XG5cbiAgICBpZiAoIWJvZHkpXG4gICAgICAgIHJldHVybiBmYWxzZTtcblxuICAgIGlmIChoYXNCb2R5U2Nyb2xsKGJvZHkpKVxuICAgICAgICByZXR1cm4gZmFsc2U7XG5cbiAgICBjb25zdCBjbGllbnRXaWR0aCAgPSBNYXRoLm1pbihlbC5jbGllbnRXaWR0aCwgYm9keS5jbGllbnRXaWR0aCk7XG4gICAgY29uc3QgY2xpZW50SGVpZ2h0ID0gTWF0aC5taW4oZWwuY2xpZW50SGVpZ2h0LCBib2R5LmNsaWVudEhlaWdodCk7XG5cbiAgICByZXR1cm4gYm9keS5zY3JvbGxIZWlnaHQgPiBjbGllbnRIZWlnaHQgfHwgYm9keS5zY3JvbGxXaWR0aCA+IGNsaWVudFdpZHRoO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gaGFzU2Nyb2xsIChlbDogRWxlbWVudCk6IGJvb2xlYW4ge1xuICAgIGlmIChhZGFwdGVyLmRvbS5pc0JvZHlFbGVtZW50KGVsKSlcbiAgICAgICAgcmV0dXJuIGhhc0JvZHlTY3JvbGwoZWwpO1xuXG4gICAgaWYgKGFkYXB0ZXIuZG9tLmlzSHRtbEVsZW1lbnQoZWwpKVxuICAgICAgICByZXR1cm4gaGFzSFRNTEVsZW1lbnRTY3JvbGwoZWwpO1xuXG4gICAgY29uc3Qgc2Nyb2xsYWJsZSA9IGdldFNjcm9sbGFibGUoZWwpO1xuXG4gICAgaWYgKCFzY3JvbGxhYmxlLnggJiYgIXNjcm9sbGFibGUueSlcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuXG4gICAgY29uc3QgaGFzVmVydGljYWxTY3JvbGwgICA9IHNjcm9sbGFibGUueSAmJiBlbC5zY3JvbGxIZWlnaHQgPiBlbC5jbGllbnRIZWlnaHQ7XG4gICAgY29uc3QgaGFzSG9yaXpvbnRhbFNjcm9sbCA9IHNjcm9sbGFibGUueCAmJiBlbC5zY3JvbGxXaWR0aCA+IGVsLmNsaWVudFdpZHRoO1xuXG4gICAgcmV0dXJuIGhhc0hvcml6b250YWxTY3JvbGwgfHwgaGFzVmVydGljYWxTY3JvbGw7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRTY3JvbGxhYmxlUGFyZW50cyAoZWxlbWVudDogRWxlbWVudCk6IEVsZW1lbnRbXSB7XG4gICAgY29uc3QgcGFyZW50c0FycmF5ID0gYWRhcHRlci5kb20uZ2V0UGFyZW50cyhlbGVtZW50KTtcblxuICAgIGlmIChhZGFwdGVyLmRvbS5pc0VsZW1lbnRJbklmcmFtZShlbGVtZW50KSkge1xuICAgICAgICBjb25zdCBpZnJhbWUgPSBhZGFwdGVyLmRvbS5nZXRJZnJhbWVCeUVsZW1lbnQoZWxlbWVudCk7XG5cbiAgICAgICAgaWYgKGlmcmFtZSkge1xuICAgICAgICAgICAgY29uc3QgaUZyYW1lUGFyZW50cyA9IGFkYXB0ZXIuZG9tLmdldFBhcmVudHMoaWZyYW1lKTtcblxuICAgICAgICAgICAgcGFyZW50c0FycmF5LmNvbmNhdChpRnJhbWVQYXJlbnRzKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBhZGFwdGVyLm5hdGl2ZU1ldGhvZHMuYXJyYXlGaWx0ZXIuY2FsbChwYXJlbnRzQXJyYXksIGhhc1Njcm9sbCk7XG59XG4iXX0=