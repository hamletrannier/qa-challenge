"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.getDocumentScroll = exports.getWindowDimensions = exports.getElementScroll = exports.getElementPadding = exports.getBordersWidth = exports.getClientDimensions = exports.getBoxModel = exports.getScroll = exports.getProperties = exports.getStyleProperties = void 0;
const boundary_values_1 = __importDefault(require("../../../../../../../shared/utils/values/boundary-values"));
const dom_utils_1 = require("./dom-utils");
const clientsManager = __importStar(require("../clients-manager"));
async function getPadding(node) {
    const client = clientsManager.getClient();
    const { nodeId } = await client.DOM.requestNode(node);
    const style = await getStyleProperties(nodeId, 'padding-right', 'padding-bottom', 'padding-left', 'padding-top');
    const right = parseInt(style['padding-right'], 10);
    const bottom = parseInt(style['padding-bottom'], 10);
    const left = parseInt(style['padding-left'], 10);
    const top = parseInt(style['padding-top'], 10);
    return new boundary_values_1.default(top, right, bottom, left);
}
async function getStyleProperties(nodeId, ...names) {
    const { CSS } = clientsManager.getClient();
    const properties = {};
    const style = await CSS.getComputedStyleForNode({ nodeId });
    style.computedStyle.filter(property => names.includes(property.name))
        .forEach(property => {
        properties[property.name] = property.value;
    });
    return properties;
}
exports.getStyleProperties = getStyleProperties;
async function getProperties(node, ...names) {
    const { Runtime } = clientsManager.getClient();
    const properties = {};
    const { result } = await Runtime.getProperties(node);
    result.filter(property => names.includes(property.name))
        .forEach(property => {
        var _a;
        properties[property.name] = (_a = property.value) === null || _a === void 0 ? void 0 : _a.value;
    });
    return properties;
}
exports.getProperties = getProperties;
async function getScroll(node) {
    const { scrollLeft, scrollTop } = await getProperties(node, 'scrollLeft', 'scrollTop');
    return { left: Number(scrollLeft), top: Number(scrollTop) };
}
exports.getScroll = getScroll;
async function getBoxModel(node) {
    const { DOM } = clientsManager.getClient();
    const boxModel = await DOM.getBoxModel({ objectId: node.objectId });
    return boxModel.model;
}
exports.getBoxModel = getBoxModel;
async function getElementDimensions(node) {
    // NOTE: for some reason this method call is required for CSS.getComputedStyleForNode
    // TODO: remove this line after the problem is clear
    await clientsManager.getClient().DOM.getDocument({});
    const boxModel = await getBoxModel(node);
    const scroll = await getScroll(node);
    const paddings = await getPadding(node);
    const { width, height, border, padding, content } = boxModel;
    const left = Math.round(border[0]);
    const top = border[1];
    const bottom = top + height;
    const right = left + width;
    const borders = {
        top: padding[1] - border[1],
        right: border[4] - padding[4],
        bottom: border[5] - padding[5],
        left: padding[0] - border[0],
    };
    const scrollbar = {
        right: Math.round(padding[2] - content[2] - paddings.right),
        bottom: Math.round(padding[7] - content[7] - paddings.bottom),
    };
    return {
        border: borders,
        bottom,
        height,
        left,
        right,
        scroll: {
            left: Math.round(Number(scroll.left)),
            top: Math.round(Number(scroll.top)),
        },
        scrollbar,
        paddings,
        top,
        width,
    };
}
async function getClientDimensions(node) {
    const elementDimensions = await getElementDimensions(node);
    const parentFrame = await dom_utils_1.getIframeByElement(node);
    if (parentFrame) {
        const frameBoxModel = await getBoxModel(parentFrame);
        elementDimensions.left -= frameBoxModel.content[0];
        elementDimensions.top -= frameBoxModel.content[1];
        elementDimensions.bottom -= frameBoxModel.content[1];
        elementDimensions.right -= frameBoxModel.content[0];
    }
    return elementDimensions;
}
exports.getClientDimensions = getClientDimensions;
async function getBordersWidth(node) {
    const dimensions = await getElementDimensions(node);
    return dimensions.border;
}
exports.getBordersWidth = getBordersWidth;
async function getElementPadding(node) {
    return getPadding(node);
}
exports.getElementPadding = getElementPadding;
async function getElementScroll(node) {
    return getScroll(node);
}
exports.getElementScroll = getElementScroll;
async function getWindowDimensions(executionContext) {
    const { Runtime } = clientsManager.getClient();
    const args = {
        expression: `({
            width: document.documentElement.clientWidth,
            height: document.documentElement.clientHeight
        })`,
        returnByValue: true,
    };
    if (executionContext)
        args.contextId = executionContext.ctxId;
    const { result } = await Runtime.evaluate(args);
    const { width, height } = result.value;
    return new boundary_values_1.default(0, width, height, 0);
}
exports.getWindowDimensions = getWindowDimensions;
async function getDocumentScroll(node) {
    const document = await dom_utils_1.getScrollingElement(node);
    return getElementScroll(document);
}
exports.getDocumentScroll = getDocumentScroll;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3R5bGUtdXRpbHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi9zcmMvYnJvd3Nlci9wcm92aWRlci9idWlsdC1pbi9kZWRpY2F0ZWQvY2hyb21lL2NkcC1jbGllbnQvdXRpbHMvc3R5bGUtdXRpbHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUNBLCtHQUE4RztBQUc5RywyQ0FBc0U7QUFFdEUsbUVBQXFEO0FBR3JELEtBQUssVUFBVSxVQUFVLENBQUUsSUFBZ0I7SUFDdkMsTUFBTSxNQUFNLEdBQU8sY0FBYyxDQUFDLFNBQVMsRUFBRSxDQUFDO0lBQzlDLE1BQU0sRUFBRSxNQUFNLEVBQUUsR0FBRyxNQUFNLE1BQU0sQ0FBQyxHQUFHLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3RELE1BQU0sS0FBSyxHQUFRLE1BQU0sa0JBQWtCLENBQUMsTUFBTSxFQUFFLGVBQWUsRUFBRSxnQkFBZ0IsRUFBRSxjQUFjLEVBQUUsYUFBYSxDQUFDLENBQUM7SUFFdEgsTUFBTSxLQUFLLEdBQUksUUFBUSxDQUFDLEtBQUssQ0FBQyxlQUFlLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQztJQUNwRCxNQUFNLE1BQU0sR0FBRyxRQUFRLENBQUMsS0FBSyxDQUFDLGdCQUFnQixDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFDckQsTUFBTSxJQUFJLEdBQUssUUFBUSxDQUFDLEtBQUssQ0FBQyxjQUFjLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQztJQUNuRCxNQUFNLEdBQUcsR0FBTSxRQUFRLENBQUMsS0FBSyxDQUFDLGFBQWEsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBRWxELE9BQU8sSUFBSSx5QkFBYyxDQUFDLEdBQUcsRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLElBQUksQ0FBQyxDQUFDO0FBQ3hELENBQUM7QUFFTSxLQUFLLFVBQVUsa0JBQWtC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LENBQUUsZ0JBQW1DO0lBQzFFLE1BQU0sRUFBRSxPQUFPLEVBQUUsR0FBRyxjQUFjLENBQUMsU0FBUyxFQUFFLENBQUM7SUFFL0MsTUFBTSxJQUFJLEdBQXFDO1FBQzNDLFVBQVUsRUFBRTs7O1dBR1Q7UUFDSCxhQUFhLEVBQUUsSUFBSTtLQUN0QixDQUFDO0lBRUYsSUFBSSxnQkFBZ0I7UUFDaEIsSUFBSSxDQUFDLFNBQVMsR0FBRyxnQkFBZ0IsQ0FBQyxLQUFLLENBQUM7SUFFNUMsTUFBTSxFQUFFLE1BQU0sRUFBRSxHQUFVLE1BQU0sT0FBTyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUN2RCxNQUFNLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBRSxHQUFHLE1BQU0sQ0FBQyxLQUFLLENBQUM7SUFFdkMsT0FBTyxJQUFJLHlCQUFjLENBQUMsQ0FBQyxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsQ0FBQyxDQUFDLENBQUM7QUFDbkQsQ0FBQztBQWxCRCxrREFrQkM7QUFFTSxLQUFLLFVBQVUsaUJBQWlCLENBQUUsSUFBZ0I7SUFDckQsTUFBTSxRQUFRLEdBQUcsTUFBTSwrQkFBbUIsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUVqRCxPQUFPLGdCQUFnQixDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBQ3RDLENBQUM7QUFKRCw4Q0FJQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IExlZnRUb3BWYWx1ZXMgfSBmcm9tICcuLi8uLi8uLi8uLi8uLi8uLi8uLi9zaGFyZWQvdXRpbHMvdmFsdWVzL2F4aXMtdmFsdWVzJztcbmltcG9ydCBCb3VuZGFyeVZhbHVlcywgeyBCb3VuZGFyeVZhbHVlc0RhdGEgfSBmcm9tICcuLi8uLi8uLi8uLi8uLi8uLi8uLi9zaGFyZWQvdXRpbHMvdmFsdWVzL2JvdW5kYXJ5LXZhbHVlcyc7XG5pbXBvcnQgeyBEaWN0aW9uYXJ5IH0gZnJvbSAnLi4vLi4vLi4vLi4vLi4vLi4vLi4vY29uZmlndXJhdGlvbi9pbnRlcmZhY2VzJztcbmltcG9ydCBQcm90b2NvbCBmcm9tICdkZXZ0b29scy1wcm90b2NvbC90eXBlcy9wcm90b2NvbCc7XG5pbXBvcnQgeyBnZXRTY3JvbGxpbmdFbGVtZW50LCBnZXRJZnJhbWVCeUVsZW1lbnQgfSBmcm9tICcuL2RvbS11dGlscyc7XG5pbXBvcnQgRXhlY3V0aW9uQ29udGV4dCBmcm9tICcuLi9leGVjdXRpb24tY29udGV4dCc7XG5pbXBvcnQgKiBhcyBjbGllbnRzTWFuYWdlciBmcm9tICcuLi9jbGllbnRzLW1hbmFnZXInO1xuaW1wb3J0IHsgU2VydmVyTm9kZSwgUG9zaXRpb25EaW1lbnNpb25zIH0gZnJvbSAnLi4vdHlwZXMnO1xuXG5hc3luYyBmdW5jdGlvbiBnZXRQYWRkaW5nIChub2RlOiBTZXJ2ZXJOb2RlKTogUHJvbWlzZTxCb3VuZGFyeVZhbHVlc0RhdGE+IHtcbiAgICBjb25zdCBjbGllbnQgICAgID0gY2xpZW50c01hbmFnZXIuZ2V0Q2xpZW50KCk7XG4gICAgY29uc3QgeyBub2RlSWQgfSA9IGF3YWl0IGNsaWVudC5ET00ucmVxdWVzdE5vZGUobm9kZSk7XG4gICAgY29uc3Qgc3R5bGUgICAgICA9IGF3YWl0IGdldFN0eWxlUHJvcGVydGllcyhub2RlSWQsICdwYWRkaW5nLXJpZ2h0JywgJ3BhZGRpbmctYm90dG9tJywgJ3BhZGRpbmctbGVmdCcsICdwYWRkaW5nLXRvcCcpO1xuXG4gICAgY29uc3QgcmlnaHQgID0gcGFyc2VJbnQoc3R5bGVbJ3BhZGRpbmctcmlnaHQnXSwgMTApO1xuICAgIGNvbnN0IGJvdHRvbSA9IHBhcnNlSW50KHN0eWxlWydwYWRkaW5nLWJvdHRvbSddLCAxMCk7XG4gICAgY29uc3QgbGVmdCAgID0gcGFyc2VJbnQoc3R5bGVbJ3BhZGRpbmctbGVmdCddLCAxMCk7XG4gICAgY29uc3QgdG9wICAgID0gcGFyc2VJbnQoc3R5bGVbJ3BhZGRpbmctdG9wJ10sIDEwKTtcblxuICAgIHJldHVybiBuZXcgQm91bmRhcnlWYWx1ZXModG9wLCByaWdodCwgYm90dG9tLCBsZWZ0KTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldFN0eWxlUHJvcGVydGllcyAobm9kZUlkOiBudW1iZXIsIC4uLm5hbWVzOiBzdHJpbmdbXSk6IFByb21pc2U8RGljdGlvbmFyeTxzdHJpbmc+PiB7XG4gICAgY29uc3QgeyBDU1MgfSA9IGNsaWVudHNNYW5hZ2VyLmdldENsaWVudCgpO1xuXG4gICAgY29uc3QgcHJvcGVydGllczogRGljdGlvbmFyeTxzdHJpbmc+ID0geyB9O1xuICAgIGNvbnN0IHN0eWxlICAgICAgICAgICAgICAgICAgICAgICAgICA9IGF3YWl0IENTUy5nZXRDb21wdXRlZFN0eWxlRm9yTm9kZSh7IG5vZGVJZCB9KTtcblxuICAgIHN0eWxlLmNvbXB1dGVkU3R5bGUuZmlsdGVyKHByb3BlcnR5ID0+IG5hbWVzLmluY2x1ZGVzKHByb3BlcnR5Lm5hbWUpKVxuICAgICAgICAuZm9yRWFjaChwcm9wZXJ0eSA9PiB7XG4gICAgICAgICAgICBwcm9wZXJ0aWVzW3Byb3BlcnR5Lm5hbWVdID0gcHJvcGVydHkudmFsdWU7XG4gICAgICAgIH0pO1xuXG4gICAgcmV0dXJuIHByb3BlcnRpZXM7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRQcm9wZXJ0aWVzIChub2RlOiBTZXJ2ZXJOb2RlLCAuLi5uYW1lczogc3RyaW5nW10pOiBQcm9taXNlPERpY3Rpb25hcnk8c3RyaW5nPj4ge1xuICAgIGNvbnN0IHsgUnVudGltZSB9ID0gY2xpZW50c01hbmFnZXIuZ2V0Q2xpZW50KCk7XG5cbiAgICBjb25zdCBwcm9wZXJ0aWVzOiBEaWN0aW9uYXJ5PHN0cmluZz4gPSB7IH07XG4gICAgY29uc3QgeyByZXN1bHQgfSAgICAgICAgICAgICAgICAgICAgID0gYXdhaXQgUnVudGltZS5nZXRQcm9wZXJ0aWVzKG5vZGUpO1xuXG4gICAgcmVzdWx0LmZpbHRlcihwcm9wZXJ0eSA9PiBuYW1lcy5pbmNsdWRlcyhwcm9wZXJ0eS5uYW1lKSlcbiAgICAgICAgLmZvckVhY2gocHJvcGVydHkgPT4ge1xuICAgICAgICAgICAgcHJvcGVydGllc1twcm9wZXJ0eS5uYW1lXSA9IHByb3BlcnR5LnZhbHVlPy52YWx1ZTtcbiAgICAgICAgfSk7XG5cbiAgICByZXR1cm4gcHJvcGVydGllcztcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldFNjcm9sbCAobm9kZTogU2VydmVyTm9kZSk6IFByb21pc2U8TGVmdFRvcFZhbHVlczxudW1iZXI+PiB7XG4gICAgY29uc3QgeyBzY3JvbGxMZWZ0LCBzY3JvbGxUb3AgfSA9IGF3YWl0IGdldFByb3BlcnRpZXMobm9kZSwgJ3Njcm9sbExlZnQnLCAnc2Nyb2xsVG9wJyk7XG5cbiAgICByZXR1cm4geyBsZWZ0OiBOdW1iZXIoc2Nyb2xsTGVmdCksIHRvcDogTnVtYmVyKHNjcm9sbFRvcCkgfTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldEJveE1vZGVsIChub2RlOiBTZXJ2ZXJOb2RlKTogUHJvbWlzZTxQcm90b2NvbC5ET00uQm94TW9kZWw+IHtcbiAgICBjb25zdCB7IERPTSB9ICA9IGNsaWVudHNNYW5hZ2VyLmdldENsaWVudCgpO1xuICAgIGNvbnN0IGJveE1vZGVsID0gYXdhaXQgRE9NLmdldEJveE1vZGVsKHsgb2JqZWN0SWQ6IG5vZGUub2JqZWN0SWQgfSk7XG5cbiAgICByZXR1cm4gYm94TW9kZWwubW9kZWw7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldEVsZW1lbnREaW1lbnNpb25zIChub2RlOiBTZXJ2ZXJOb2RlKTogUHJvbWlzZTxQb3NpdGlvbkRpbWVuc2lvbnM+IHtcbiAgICAvLyBOT1RFOiBmb3Igc29tZSByZWFzb24gdGhpcyBtZXRob2QgY2FsbCBpcyByZXF1aXJlZCBmb3IgQ1NTLmdldENvbXB1dGVkU3R5bGVGb3JOb2RlXG4gICAgLy8gVE9ETzogcmVtb3ZlIHRoaXMgbGluZSBhZnRlciB0aGUgcHJvYmxlbSBpcyBjbGVhclxuICAgIGF3YWl0IGNsaWVudHNNYW5hZ2VyLmdldENsaWVudCgpLkRPTS5nZXREb2N1bWVudCh7IH0pO1xuXG4gICAgY29uc3QgYm94TW9kZWwgPSBhd2FpdCBnZXRCb3hNb2RlbChub2RlKTtcbiAgICBjb25zdCBzY3JvbGwgICA9IGF3YWl0IGdldFNjcm9sbChub2RlKTtcbiAgICBjb25zdCBwYWRkaW5ncyA9IGF3YWl0IGdldFBhZGRpbmcobm9kZSk7XG5cbiAgICBjb25zdCB7IHdpZHRoLCBoZWlnaHQsIGJvcmRlciwgcGFkZGluZywgY29udGVudCB9ID0gYm94TW9kZWw7XG5cbiAgICBjb25zdCBsZWZ0ICAgPSBNYXRoLnJvdW5kKGJvcmRlclswXSk7XG4gICAgY29uc3QgdG9wICAgID0gYm9yZGVyWzFdO1xuICAgIGNvbnN0IGJvdHRvbSA9IHRvcCArIGhlaWdodDtcbiAgICBjb25zdCByaWdodCAgPSBsZWZ0ICsgd2lkdGg7XG5cbiAgICBjb25zdCBib3JkZXJzID0ge1xuICAgICAgICB0b3A6ICAgIHBhZGRpbmdbMV0gLSBib3JkZXJbMV0sXG4gICAgICAgIHJpZ2h0OiAgYm9yZGVyWzRdIC0gcGFkZGluZ1s0XSxcbiAgICAgICAgYm90dG9tOiBib3JkZXJbNV0gLSBwYWRkaW5nWzVdLFxuICAgICAgICBsZWZ0OiAgIHBhZGRpbmdbMF0gLSBib3JkZXJbMF0sXG4gICAgfTtcblxuICAgIGNvbnN0IHNjcm9sbGJhciA9IHtcbiAgICAgICAgcmlnaHQ6ICBNYXRoLnJvdW5kKHBhZGRpbmdbMl0gLSBjb250ZW50WzJdIC0gcGFkZGluZ3MucmlnaHQpLFxuICAgICAgICBib3R0b206IE1hdGgucm91bmQocGFkZGluZ1s3XSAtIGNvbnRlbnRbN10gLSBwYWRkaW5ncy5ib3R0b20pLFxuICAgIH07XG5cbiAgICByZXR1cm4ge1xuICAgICAgICBib3JkZXI6IGJvcmRlcnMsXG4gICAgICAgIGJvdHRvbSxcbiAgICAgICAgaGVpZ2h0LFxuICAgICAgICBsZWZ0LFxuICAgICAgICByaWdodCxcbiAgICAgICAgc2Nyb2xsOiB7XG4gICAgICAgICAgICBsZWZ0OiBNYXRoLnJvdW5kKE51bWJlcihzY3JvbGwubGVmdCkpLFxuICAgICAgICAgICAgdG9wOiAgTWF0aC5yb3VuZChOdW1iZXIoc2Nyb2xsLnRvcCkpLFxuICAgICAgICB9LFxuICAgICAgICBzY3JvbGxiYXIsXG4gICAgICAgIHBhZGRpbmdzLFxuICAgICAgICB0b3AsXG4gICAgICAgIHdpZHRoLFxuICAgIH07XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRDbGllbnREaW1lbnNpb25zIChub2RlOiBTZXJ2ZXJOb2RlKTogUHJvbWlzZTxQb3NpdGlvbkRpbWVuc2lvbnM+IHtcbiAgICBjb25zdCBlbGVtZW50RGltZW5zaW9ucyA9IGF3YWl0IGdldEVsZW1lbnREaW1lbnNpb25zKG5vZGUpO1xuICAgIGNvbnN0IHBhcmVudEZyYW1lICAgICAgID0gYXdhaXQgZ2V0SWZyYW1lQnlFbGVtZW50KG5vZGUpO1xuXG4gICAgaWYgKHBhcmVudEZyYW1lKSB7XG4gICAgICAgIGNvbnN0IGZyYW1lQm94TW9kZWwgPSBhd2FpdCBnZXRCb3hNb2RlbChwYXJlbnRGcmFtZSk7XG5cbiAgICAgICAgZWxlbWVudERpbWVuc2lvbnMubGVmdCAgIC09IGZyYW1lQm94TW9kZWwuY29udGVudFswXTtcbiAgICAgICAgZWxlbWVudERpbWVuc2lvbnMudG9wICAgIC09IGZyYW1lQm94TW9kZWwuY29udGVudFsxXTtcbiAgICAgICAgZWxlbWVudERpbWVuc2lvbnMuYm90dG9tIC09IGZyYW1lQm94TW9kZWwuY29udGVudFsxXTtcbiAgICAgICAgZWxlbWVudERpbWVuc2lvbnMucmlnaHQgIC09IGZyYW1lQm94TW9kZWwuY29udGVudFswXTtcbiAgICB9XG5cbiAgICByZXR1cm4gZWxlbWVudERpbWVuc2lvbnM7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRCb3JkZXJzV2lkdGggKG5vZGU6IFNlcnZlck5vZGUpOiBQcm9taXNlPEJvdW5kYXJ5VmFsdWVzRGF0YT4ge1xuICAgIGNvbnN0IGRpbWVuc2lvbnMgPSBhd2FpdCBnZXRFbGVtZW50RGltZW5zaW9ucyhub2RlKTtcblxuICAgIHJldHVybiBkaW1lbnNpb25zLmJvcmRlcjtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldEVsZW1lbnRQYWRkaW5nIChub2RlOiBTZXJ2ZXJOb2RlKTogUHJvbWlzZTxCb3VuZGFyeVZhbHVlc0RhdGE+IHtcbiAgICByZXR1cm4gZ2V0UGFkZGluZyhub2RlKTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldEVsZW1lbnRTY3JvbGwgKG5vZGU6IFNlcnZlck5vZGUpOiBQcm9taXNlPExlZnRUb3BWYWx1ZXM8bnVtYmVyPj4ge1xuICAgIHJldHVybiBnZXRTY3JvbGwobm9kZSk7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRXaW5kb3dEaW1lbnNpb25zIChleGVjdXRpb25Db250ZXh0PzogRXhlY3V0aW9uQ29udGV4dCk6IFByb21pc2U8Qm91bmRhcnlWYWx1ZXM+IHtcbiAgICBjb25zdCB7IFJ1bnRpbWUgfSA9IGNsaWVudHNNYW5hZ2VyLmdldENsaWVudCgpO1xuXG4gICAgY29uc3QgYXJnczogUHJvdG9jb2wuUnVudGltZS5FdmFsdWF0ZVJlcXVlc3QgPSB7XG4gICAgICAgIGV4cHJlc3Npb246IGAoe1xuICAgICAgICAgICAgd2lkdGg6IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5jbGllbnRXaWR0aCxcbiAgICAgICAgICAgIGhlaWdodDogZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmNsaWVudEhlaWdodFxuICAgICAgICB9KWAsXG4gICAgICAgIHJldHVybkJ5VmFsdWU6IHRydWUsXG4gICAgfTtcblxuICAgIGlmIChleGVjdXRpb25Db250ZXh0KVxuICAgICAgICBhcmdzLmNvbnRleHRJZCA9IGV4ZWN1dGlvbkNvbnRleHQuY3R4SWQ7XG5cbiAgICBjb25zdCB7IHJlc3VsdCB9ICAgICAgICA9IGF3YWl0IFJ1bnRpbWUuZXZhbHVhdGUoYXJncyk7XG4gICAgY29uc3QgeyB3aWR0aCwgaGVpZ2h0IH0gPSByZXN1bHQudmFsdWU7XG5cbiAgICByZXR1cm4gbmV3IEJvdW5kYXJ5VmFsdWVzKDAsIHdpZHRoLCBoZWlnaHQsIDApO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0RG9jdW1lbnRTY3JvbGwgKG5vZGU6IFNlcnZlck5vZGUpOiBQcm9taXNlPExlZnRUb3BWYWx1ZXM8bnVtYmVyPj4ge1xuICAgIGNvbnN0IGRvY3VtZW50ID0gYXdhaXQgZ2V0U2Nyb2xsaW5nRWxlbWVudChub2RlKTtcblxuICAgIHJldHVybiBnZXRFbGVtZW50U2Nyb2xsKGRvY3VtZW50KTtcbn1cbiJdfQ==