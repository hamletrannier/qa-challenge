"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const fs_1 = __importDefault(require("fs"));
const compiler_1 = __importDefault(require("../../compiler"));
const test_run_proxy_1 = __importDefault(require("./test-run-proxy"));
const test_controller_1 = __importDefault(require("../../api/test-controller"));
const test_structure_1 = require("../serialization/test-structure");
const io_1 = require("./io");
const proxy_1 = require("../utils/ipc/proxy");
const transport_1 = require("../utils/ipc/transport");
const protocol_1 = require("./protocol");
const process_title_1 = __importDefault(require("../process-title"));
const hook_method_names_1 = __importDefault(require("../../api/request-hooks/hook-method-names"));
const testcafe_hammerhead_1 = require("testcafe-hammerhead");
const user_variables_1 = __importDefault(require("../../api/user-variables"));
const execute_js_expression_1 = require("../../test-run/execute-js-expression");
const test_run_1 = require("../../errors/test-run");
const utils_1 = require("../../errors/test-run/render-error-template/utils");
const setup_sourcemap_support_1 = __importDefault(require("../../utils/setup-sourcemap-support"));
const handle_errors_1 = require("../../utils/handle-errors");
const errors_1 = require("../../shared/errors");
const lodash_1 = require("lodash");
setup_sourcemap_support_1.default();
// This is hack for supporting the 'import { t } from "testcafe"' expression in tests.
// It caused by using the 'esm' module.
require('../../api/test-controller/proxy');
class CompilerService {
    constructor() {
        process.title = process_title_1.default.service;
        const input = fs_1.default.createReadStream('', { fd: io_1.SERVICE_INPUT_FD });
        const output = fs_1.default.createWriteStream('', { fd: io_1.SERVICE_OUTPUT_FD });
        this.proxy = new proxy_1.IPCProxy(new transport_1.ServiceTransport(input, output, io_1.SERVICE_SYNC_FD));
        this.state = this._initState();
        this._runnableConfigurationUnitsRelations = {};
        this._registerErrorHandlers();
        this._setupRoutes();
        this.ready();
    }
    _initState() {
        return {
            testRuns: {},
            fixtureCtxs: {},
            units: {},
            options: {},
            roles: new Map(),
        };
    }
    async _handleUnexpectedError(ErrorCtor, error) {
        const message = handle_errors_1.formatError(ErrorCtor, error);
        const type = ErrorCtor.name;
        await this.addUnexpectedError({ type, message });
    }
    _registerErrorHandlers() {
        process.on('unhandledRejection', async (e) => this._handleUnexpectedError(test_run_1.UnhandledPromiseRejectionError, e));
        process.on('uncaughtException', async (e) => this._handleUnexpectedError(test_run_1.UncaughtExceptionError, e));
    }
    _getFixtureCtx(unit) {
        const fixtureId = test_structure_1.isTest(unit) ? unit.fixture.id : unit.id;
        return this.state.fixtureCtxs[fixtureId];
    }
    _getTestCtx({ testRunId }, unit) {
        const testRunProxy = this._getTargetTestRun(testRunId);
        testRunProxy.fixtureCtx = this._getFixtureCtx(unit);
        return testRunProxy;
    }
    _getContext(args, unit) {
        const { testRunId } = args;
        if (testRunId)
            return this._getTestCtx(args, unit);
        return this._getFixtureCtx(unit);
    }
    _setupRoutes() {
        this.proxy.register([
            this.getTests,
            this.runTestFn,
            this.cleanUp,
            this.setOptions,
            this.onRequestHookEvent,
            this.setMock,
            this.setConfigureResponseEventOptions,
            this.setHeaderOnConfigureResponseEvent,
            this.removeHeaderOnConfigureResponseEvent,
            this.executeRequestFilterRulePredicate,
            this.executeMockPredicate,
            this.getWarningMessages,
            this.addRequestEventListeners,
            this.removeRequestEventListeners,
            this.initializeTestRunData,
            this.getAssertionActualValue,
            this.executeRoleInitFn,
            this.getCtx,
            this.getFixtureCtx,
            this.setCtx,
            this.setFixtureCtx,
            this.updateRoleProperty,
            this.executeJsExpression,
            this.executeAsyncJsExpression,
            this.addUnexpectedError,
            this.checkWindow,
            this.removeTestRunFromState,
            this.removeFixtureCtxsFromState,
            this.removeUnitsFromState,
        ], this);
    }
    _getFunction(unit, functionName) {
        if (test_structure_1.isTest(unit) && protocol_1.isTestFunctionProperty(functionName))
            return unit[functionName];
        if (test_structure_1.isFixture(unit) && protocol_1.isFixtureFunctionProperty(functionName))
            return unit[functionName];
        throw new Error(`Cannot find '${functionName}' function for ${typeof unit}`);
    }
    _wrapEventMethods({ name, testId, hookId, eventData }) {
        if (name === hook_method_names_1.default.onRequest)
            this._wrapSetMockFn({ testId, hookId, event: eventData });
        else if (name === hook_method_names_1.default._onConfigureResponse)
            this._wrapConfigureResponseEventMethods(eventData);
    }
    _wrapSetMockFn({ testId, hookId, event }) {
        event.setMock = async (mock) => {
            await this.setMock({
                responseEventId: event.id,
                ruleId: event.requestFilterRule.id,
                testId,
                hookId,
                mock,
            });
        };
    }
    _wrapConfigureResponseEventMethods(event) {
        event.setHeader = async (name, value) => {
            await this.setHeaderOnConfigureResponseEvent({
                eventId: event.id,
                headerName: name,
                headerValue: value,
            });
        };
        event.removeHeader = async (name) => {
            await this.removeHeaderOnConfigureResponseEvent({
                eventId: event.id,
                headerName: name,
            });
        };
    }
    _initializeTestRunProxy({ testRunId, test, browser, activeWindowId, messageBus }) {
        const testRunProxy = new test_run_proxy_1.default({
            dispatcher: this,
            id: testRunId,
            options: this.state.options,
            test,
            browser,
            activeWindowId,
            messageBus,
        });
        this.state.testRuns[testRunId] = testRunProxy;
    }
    _initializeFixtureCtx(test) {
        const fixtureId = test.fixture.id;
        if (this.state.fixtureCtxs[fixtureId])
            return;
        this.state.fixtureCtxs[fixtureId] = Object.create(null);
    }
    _getTargetTestRun(testRunId) {
        return this.state.testRuns[testRunId];
    }
    _getTargetRole(roleId) {
        return this.state.roles.get(roleId);
    }
    _updateUserVariables(value) {
        user_variables_1.default.value = value;
    }
    _getUnitIds(tests) {
        const testIds = tests.map(test => test.id);
        const fixtureIds = tests.map(test => { var _a; return (_a = test.fixture) === null || _a === void 0 ? void 0 : _a.id; });
        const testFileIds = tests.map(test => test.testFile.id);
        return lodash_1.uniq([...testIds, ...fixtureIds, ...testFileIds]);
    }
    async setOptions({ value }) {
        this.state.options = value;
        this._updateUserVariables(value.userVariables);
    }
    async ready() {
        this.proxy.call(this.ready);
    }
    async cleanUp() {
        await compiler_1.default.cleanUp();
    }
    async getTests({ sourceList, compilerOptions, runnableConfigurationId }) {
        const compiler = new compiler_1.default(sourceList, compilerOptions, true);
        const tests = await compiler.getTests();
        const units = test_structure_1.flatten(tests);
        const unitIds = this._getUnitIds(tests);
        this._runnableConfigurationUnitsRelations[runnableConfigurationId] = unitIds;
        Object.assign(this.state.units, units);
        return test_structure_1.serialize(units);
    }
    async runTestFn(args) {
        const { id, functionName } = args;
        const unit = this.state.units[id];
        const context = this._getContext(args, unit);
        const functionObject = this._getFunction(unit, functionName);
        if (!functionObject)
            throw new Error(`Cannot find the "${functionName}" of ${typeof unit}`);
        return await functionObject(context);
    }
    executeCommandSync({ id, command, callsite }) {
        return this.proxy.callSync(this.executeCommand, { id, command, callsite });
    }
    async executeCommand({ command, id, callsite }) {
        return this.proxy.call(this.executeCommand, { id, command, callsite });
    }
    async onRequestHookEvent({ name, testId, hookId, eventData }) {
        this._wrapEventMethods({ name, testId, hookId, eventData });
        const test = this.state.units[testId];
        const targetHook = test.requestHooks.find(hook => hook.id === hookId);
        // @ts-ignore
        await targetHook[name].call(targetHook, eventData);
        if (name === hook_method_names_1.default._onConfigureResponse && targetHook._responseEventConfigureOpts) {
            const { opts, id: eventId } = eventData;
            await this.setConfigureResponseEventOptions({ eventId, opts });
        }
    }
    async setMock({ testId, hookId, ruleId, responseEventId, mock }) {
        await this.proxy.call(this.setMock, { testId, hookId, ruleId, responseEventId, mock });
    }
    async setConfigureResponseEventOptions({ eventId, opts }) {
        await this.proxy.call(this.setConfigureResponseEventOptions, { eventId, opts });
    }
    async setHeaderOnConfigureResponseEvent({ eventId, headerName, headerValue }) {
        await this.proxy.call(this.setHeaderOnConfigureResponseEvent, { eventId, headerName, headerValue });
    }
    async removeHeaderOnConfigureResponseEvent({ eventId, headerName }) {
        await this.proxy.call(this.removeHeaderOnConfigureResponseEvent, { eventId, headerName });
    }
    async executeRequestFilterRulePredicate({ testId, hookId, ruleId, requestInfo }) {
        const test = this.state.units[testId];
        const targetHook = test.requestHooks.find(hook => hook.id === hookId);
        const targetRule = targetHook._requestFilterRules.find(rule => rule.id === ruleId);
        const result = await targetRule.options.call(targetRule, requestInfo);
        return !!result;
    }
    async executeMockPredicate({ testId, hookId, ruleId, requestInfo, res }) {
        const test = this.state.units[testId];
        const requestMock = test.requestHooks.find(hook => hook.id === hookId);
        const responseMock = requestMock.mocks.get(ruleId);
        testcafe_hammerhead_1.responseMockSetBodyMethod.add(res);
        res = Object.assign(res, await responseMock.body(requestInfo, res));
        testcafe_hammerhead_1.responseMockSetBodyMethod.remove(res);
        return res;
    }
    async getWarningMessages({ testRunId }) {
        // NOTE: In case of raising an error into ReporterPluginHost methods,
        // TestRun has time to start.
        const targetTestRun = this._getTargetTestRun(testRunId);
        return targetTestRun ? targetTestRun.warningLog.messageInfos : [];
    }
    async addRequestEventListeners({ hookId, hookClassName, rules }) {
        return await this.proxy.call(this.addRequestEventListeners, { hookId, hookClassName, rules });
    }
    async removeRequestEventListeners({ rules }) {
        return await this.proxy.call(this.removeRequestEventListeners, { rules });
    }
    async initializeTestRunData({ testRunId, testId, browser, activeWindowId, messageBus }) {
        // NOTE: In case of raising an error into ReporterPluginHost methods,
        // TestRun has time to start.
        const test = this.state.units[testId];
        if (!test)
            return;
        this._initializeTestRunProxy({ testRunId, test, browser, activeWindowId, messageBus });
        this._initializeFixtureCtx(test);
    }
    enableDebugForNonDebugCommands() {
        test_controller_1.default.enableDebugForNonDebugCommands();
    }
    disableDebugForNonDebugCommands() {
        test_controller_1.default.disableDebugForNonDebugCommands();
    }
    async getAssertionActualValue({ testRunId, commandId }) {
        return this._getTargetTestRun(testRunId).getAssertionActualValue(commandId);
    }
    async executeRoleInitFn({ testRunId, roleId }) {
        const role = this._getTargetRole(roleId);
        const testRunProxy = this._getTargetTestRun(testRunId);
        return role._initFn(testRunProxy);
    }
    async getCtx({ testRunId }) {
        return this._getTargetTestRun(testRunId).ctx;
    }
    async getFixtureCtx({ testRunId }) {
        return this._getTargetTestRun(testRunId).fixtureCtx;
    }
    async setCtx({ testRunId, value }) {
        this._getTargetTestRun(testRunId).ctx = value;
    }
    async setFixtureCtx({ testRunId, value }) {
        this._getTargetTestRun(testRunId).fixtureCtx = value;
    }
    onRoleAppeared(role) {
        if (this.state.roles.has(role.id))
            return;
        this.state.roles.set(role.id, role);
    }
    async updateRoleProperty({ roleId, name, value }) {
        const role = this._getTargetRole(roleId);
        // @ts-ignore
        role[name] = value;
    }
    async executeJsExpression({ expression, testRunId, options }) {
        const testRunProxy = this._getTargetTestRun(testRunId);
        return execute_js_expression_1.executeJsExpression(expression, testRunProxy, options);
    }
    async executeAsyncJsExpression({ expression, testRunId, callsite }) {
        const testRunProxy = this._getTargetTestRun(testRunId);
        return execute_js_expression_1.executeAsyncJsExpression(expression, testRunProxy, callsite, async (err) => {
            if (err instanceof test_run_1.UncaughtTestCafeErrorInCustomScript === false)
                return;
            const targetError = err;
            if (!utils_1.shouldRenderHtmlWithoutStack(targetError))
                return;
            testRunProxy.restoreOriginCallsiteForError(targetError);
            // @ts-ignore
            err.errCallsite = utils_1.renderHtmlWithoutStack(targetError);
        });
    }
    async executeAssertionFn({ testRunId, commandId }) {
        return this
            ._getTargetTestRun(testRunId)
            .executeAssertionFn(commandId);
    }
    async addUnexpectedError({ type, message }) {
        return this.proxy.call(this.addUnexpectedError, { type, message });
    }
    async checkWindow({ testRunId, commandId, url, title }) {
        try {
            return this
                ._getTargetTestRun(testRunId)
                .checkWindow(commandId, { title, url });
        }
        catch (err) {
            throw new errors_1.SwitchToWindowPredicateError(err.message);
        }
    }
    async removeTestRunFromState({ testRunId }) {
        delete this.state.testRuns[testRunId];
    }
    async removeFixtureCtxsFromState({ fixtureIds }) {
        for (const fixtureId of fixtureIds)
            delete this.state.fixtureCtxs[fixtureId];
    }
    async removeUnitsFromState({ runnableConfigurationId }) {
        const unitIds = this._runnableConfigurationUnitsRelations[runnableConfigurationId];
        for (const unitId of unitIds)
            delete this.state.units[unitId];
        delete this._runnableConfigurationUnitsRelations[runnableConfigurationId];
    }
}
exports.default = new CompilerService();
module.exports = exports.default;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zZXJ2aWNlcy9jb21waWxlci9zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsNENBQW9CO0FBQ3BCLDhEQUFzQztBQUN0QyxzRUFBNEM7QUFDNUMsZ0ZBQXVEO0FBRXZELG9FQU95QztBQUV6Qyw2QkFJYztBQUVkLDhDQUE4QztBQUM5QyxzREFBMEQ7QUFFMUQseUNBTW9CO0FBZ0NwQixxRUFBNEM7QUFFNUMsa0dBQStFO0FBRS9FLDZEQU82QjtBQUs3Qiw4RUFBcUQ7QUFDckQsZ0ZBQXFHO0FBRXJHLG9EQUsrQjtBQUUvQiw2RUFBeUg7QUFDekgsa0dBQXdFO0FBQ3hFLDZEQUF3RDtBQUN4RCxnREFBbUU7QUFHbkUsbUNBQThCO0FBRTlCLGlDQUFxQixFQUFFLENBQUM7QUFFeEIsc0ZBQXNGO0FBQ3RGLHVDQUF1QztBQUN2QyxPQUFPLENBQUMsaUNBQWlDLENBQUMsQ0FBQztBQXNCM0MsTUFBTSxlQUFlO0lBS2pCO1FBQ0ksT0FBTyxDQUFDLEtBQUssR0FBRyx1QkFBWSxDQUFDLE9BQU8sQ0FBQztRQUVyQyxNQUFNLEtBQUssR0FBSSxZQUFFLENBQUMsZ0JBQWdCLENBQUMsRUFBRSxFQUFFLEVBQUUsRUFBRSxFQUFFLHFCQUFnQixFQUFFLENBQUMsQ0FBQztRQUNqRSxNQUFNLE1BQU0sR0FBRyxZQUFFLENBQUMsaUJBQWlCLENBQUMsRUFBRSxFQUFFLEVBQUUsRUFBRSxFQUFFLHNCQUFpQixFQUFFLENBQUMsQ0FBQztRQUVuRSxJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksZ0JBQVEsQ0FBQyxJQUFJLDRCQUFnQixDQUFDLEtBQUssRUFBRSxNQUFNLEVBQUUsb0JBQWUsQ0FBQyxDQUFDLENBQUM7UUFDaEYsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7UUFFL0IsSUFBSSxDQUFDLG9DQUFvQyxHQUFH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QUFFLEtBQUssRUFBdUI7UUFDL0UsSUFBSTtZQUNBLE9BQU8sSUFBSTtpQkFDTixpQkFBaUIsQ0FBQyxTQUFTLENBQUM7aUJBQzVCLFdBQVcsQ0FBQyxTQUFTLEVBQUUsRUFBRSxLQUFLLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQztTQUMvQztRQUNELE9BQU8sR0FBRyxFQUFFO1lBQ1IsTUFBTSxJQUFJLHFDQUE0QixDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsQ0FBQztTQUN2RDtJQUNMLENBQUM7SUFFTSxLQUFLLENBQUMsc0JBQXNCLENBQUUsRUFBRSxTQUFTLEVBQWtCO1FBQzlELE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLENBQUM7SUFDMUMsQ0FBQztJQUVNLEtBQUssQ0FBQywwQkFBMEIsQ0FBRSxFQUFFLFVBQVUsRUFBOEI7UUFDL0UsS0FBSyxNQUFNLFNBQVMsSUFBSSxVQUFVO1lBQzlCLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUMsU0FBUyxDQUFDLENBQUM7SUFDakQsQ0FBQztJQUVNLEtBQUssQ0FBQyxvQkFBb0IsQ0FBRSxFQUFFLHVCQUF1QixFQUFpQztRQUN6RixNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsb0NBQW9DLENBQUMsdUJBQXVCLENBQUMsQ0FBQztRQUVuRixLQUFLLE1BQU0sTUFBTSxJQUFJLE9BQU87WUFDeEIsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUVwQyxPQUFPLElBQUksQ0FBQyxvQ0FBb0MsQ0FBQyx1QkFBdUIsQ0FBQyxDQUFDO0lBQzlFLENBQUM7Q0FDSjtBQUVELGtCQUFlLElBQUksZUFBZSxFQUFFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgZnMgZnJvbSAnZnMnO1xuaW1wb3J0IENvbXBpbGVyIGZyb20gJy4uLy4uL2NvbXBpbGVyJztcbmltcG9ydCBUZXN0UnVuUHJveHkgZnJvbSAnLi90ZXN0LXJ1bi1wcm94eSc7XG5pbXBvcnQgVGVzdENvbnRyb2xsZXIgZnJvbSAnLi4vLi4vYXBpL3Rlc3QtY29udHJvbGxlcic7XG5cbmltcG9ydCB7XG4gICAgZmxhdHRlbiBhcyBmbGF0dGVuVGVzdFN0cnVjdHVyZSxcbiAgICBpc0ZpeHR1cmUsXG4gICAgaXNUZXN0LFxuICAgIHNlcmlhbGl6ZSBhcyBzZXJpYWxpemVUZXN0U3RydWN0dXJlLFxuICAgIFVuaXQsXG4gICAgVW5pdHMsXG59IGZyb20gJy4uL3NlcmlhbGl6YXRpb24vdGVzdC1zdHJ1Y3R1cmUnO1xuXG5pbXBvcnQge1xuICAgIFNFUlZJQ0VfSU5QVVRfRkQsXG4gICAgU0VSVklDRV9PVVRQVVRfRkQsXG4gICAgU0VSVklDRV9TWU5DX0ZELFxufSBmcm9tICcuL2lvJztcblxuaW1wb3J0IHsgSVBDUHJveHkgfSBmcm9tICcuLi91dGlscy9pcGMvcHJveHknO1xuaW1wb3J0IHsgU2VydmljZVRyYW5zcG9ydCB9IGZyb20gJy4uL3V0aWxzL2lwYy90cmFuc3BvcnQnO1xuXG5pbXBvcnQge1xuICAgIENvbXBpbGVyUHJvdG9jb2wsXG4gICAgRnVuY3Rpb25Qcm9wZXJ0aWVzLFxuICAgIGlzRml4dHVyZUZ1bmN0aW9uUHJvcGVydHksXG4gICAgaXNUZXN0RnVuY3Rpb25Qcm9wZXJ0eSxcbiAgICBSdW5UZXN0QXJndW1lbnRzLFxufSBmcm9tICcuL3Byb3RvY29sJztcblxuaW1wb3J0IHtcbiAgICBFeGVjdXRlQ29tbWFuZEFyZ3VtZW50cyxcbiAgICBFeGVjdXRlTW9ja1ByZWRpY2F0ZSxcbiAgICBFeGVjdXRlUmVxdWVzdEZpbHRlclJ1bGVQcmVkaWNhdGVBcmd1bWVudHMsXG4gICAgUmVtb3ZlSGVhZGVyT25Db25maWd1cmVSZXNwb25zZUV2ZW50QXJndW1lbnRzLFxuICAgIFJlcXVlc3RIb29rRXZlbnRBcmd1bWVudHMsXG4gICAgUmVxdWVzdEhvb2tMb2NhdG9yLFxuICAgIFNldENvbmZpZ3VyZVJlc3BvbnNlRXZlbnRPcHRpb25zQXJndW1lbnRzLFxuICAgIFNldEhlYWRlck9uQ29uZmlndXJlUmVzcG9uc2VFdmVudEFyZ3VtZW50cyxcbiAgICBTZXRNb2NrQXJndW1lbnRzLFxuICAgIFNldE9wdGlvbnNBcmd1bWVudHMsXG4gICAgQWRkUmVxdWVzdEV2ZW50TGlzdGVuZXJzQXJndW1lbnRzLFxuICAgIFJlbW92ZVJlcXVlc3RFdmVudExpc3RlbmVyc0FyZ3VtZW50cyxcbiAgICBJbml0aWFsaXplVGVzdFJ1bkRhdGFBcmd1bWVudHMsXG4gICAgVGVzdFJ1bkxvY2F0b3IsXG4gICAgU2V0Q3R4QXJndW1lbnRzLFxuICAgIEV4ZWN1dGVSb2xlSW5pdEZuQXJndW1lbnRzLFxuICAgIFVwZGF0ZVJvbGVQcm9wZXJ0eUFyZ3VtZW50cyxcbiAgICBFeGVjdXRlSnNFeHByZXNzaW9uQXJndW1lbnRzLFxuICAgIEV4ZWN1dGVBc3luY0pzRXhwcmVzc2lvbkFyZ3VtZW50cyxcbiAgICBDb21tYW5kTG9jYXRvcixcbiAgICBBZGRVbmV4cGVjdGVkRXJyb3JBcmd1bWVudHMsXG4gICAgQ2hlY2tXaW5kb3dBcmd1bWVudCxcbiAgICBSZW1vdmVGaXh0dXJlQ3R4c0FyZ3VtZW50cyxcbiAgICBSZW1vdmVVbml0c0Zyb21TdGF0ZUFyZ3VtZW50cyxcbn0gZnJvbSAnLi9pbnRlcmZhY2VzJztcblxuaW1wb3J0IHsgQ29tcGlsZXJBcmd1bWVudHMgfSBmcm9tICcuLi8uLi9jb21waWxlci9pbnRlcmZhY2VzJztcbmltcG9ydCBGaXh0dXJlIGZyb20gJy4uLy4uL2FwaS9zdHJ1Y3R1cmUvZml4dHVyZSc7XG5pbXBvcnQgeyBEaWN0aW9uYXJ5IH0gZnJvbSAnLi4vLi4vY29uZmlndXJhdGlvbi9pbnRlcmZhY2VzJztcbmltcG9ydCBQcm9jZXNzVGl0bGUgZnJvbSAnLi4vcHJvY2Vzcy10aXRsZSc7XG5pbXBvcnQgVGVzdCBmcm9tICcuLi8uLi9hcGkvc3RydWN0dXJlL3Rlc3QnO1xuaW1wb3J0IFJlcXVlc3RIb29rTWV0aG9kTmFtZXMgZnJvbSAnLi4vLi4vYXBpL3JlcXVlc3QtaG9va3MvaG9vay1tZXRob2QtbmFtZXMnO1xuXG5pbXBvcnQge1xuICAgIENvbmZpZ3VyZVJlc3BvbnNlRXZlbnQsXG4gICAgSW5jb21pbmdNZXNzYWdlTGlrZUluaXRPcHRpb25zLFxuICAgIFJlcXVlc3RFdmVudCxcbiAgICBSZXF1ZXN0RmlsdGVyUnVsZSxcbiAgICBSZXNwb25zZU1vY2ssXG4gICAgcmVzcG9uc2VNb2NrU2V0Qm9keU1ldGhvZCxcbn0gZnJvbSAndGVzdGNhZmUtaGFtbWVyaGVhZCc7XG5cbmltcG9ydCBSZXF1ZXN0SG9vayBmcm9tICcuLi8uLi9hcGkvcmVxdWVzdC1ob29rcy9ob29rJztcbmltcG9ydCBSZXF1ZXN0TW9jayBmcm9tICcuLi8uLi9hcGkvcmVxdWVzdC1ob29rcy9yZXF1ZXN0LW1vY2snO1xuaW1wb3J0IFJvbGUgZnJvbSAnLi4vLi4vcm9sZS9yb2xlJztcbmltcG9ydCB1c2VyVmFyaWFibGVzIGZyb20gJy4uLy4uL2FwaS91c2VyLXZhcmlhYmxlcyc7XG5pbXBvcnQgeyBleGVjdXRlSnNFeHByZXNzaW9uLCBleGVjdXRlQXN5bmNKc0V4cHJlc3Npb24gfSBmcm9tICcuLi8uLi90ZXN0LXJ1bi9leGVjdXRlLWpzLWV4cHJlc3Npb24nO1xuXG5pbXBvcnQge1xuICAgIFVuY2F1Z2h0RXJyb3JJbkN1c3RvbVNjcmlwdCxcbiAgICBVbmNhdWdodEV4Y2VwdGlvbkVycm9yLFxuICAgIFVuY2F1Z2h0VGVzdENhZmVFcnJvckluQ3VzdG9tU2NyaXB0LFxuICAgIFVuaGFuZGxlZFByb21pc2VSZWplY3Rpb25FcnJvcixcbn0gZnJvbSAnLi4vLi4vZXJyb3JzL3Rlc3QtcnVuJztcblxuaW1wb3J0IHsgcmVuZGVySHRtbFdpdGhvdXRTdGFjaywgc2hvdWxkUmVuZGVySHRtbFdpdGhvdXRTdGFjayB9IGZyb20gJy4uLy4uL2Vycm9ycy90ZXN0LXJ1bi9yZW5kZXItZXJyb3ItdGVtcGxhdGUvdXRpbHMnO1xuaW1wb3J0IHNldHVwU291cmNlTWFwU3VwcG9ydCBmcm9tICcuLi8uLi91dGlscy9zZXR1cC1zb3VyY2VtYXAtc3VwcG9ydCc7XG5pbXBvcnQgeyBmb3JtYXRFcnJvciB9IGZyb20gJy4uLy4uL3V0aWxzL2hhbmRsZS1lcnJvcnMnO1xuaW1wb3J0IHsgU3dpdGNoVG9XaW5kb3dQcmVkaWNhdGVFcnJvciB9IGZyb20gJy4uLy4uL3NoYXJlZC9lcnJvcnMnO1xuaW1wb3J0IE1lc3NhZ2VCdXMgZnJvbSAnLi4vLi4vdXRpbHMvbWVzc2FnZS1idXMnO1xuaW1wb3J0IHsgV2FybmluZ0xvZ01lc3NhZ2UgfSBmcm9tICcuLi8uLi9ub3RpZmljYXRpb25zL3dhcm5pbmctbG9nJztcbmltcG9ydCB7IHVuaXEgfSBmcm9tICdsb2Rhc2gnO1xuXG5zZXR1cFNvdXJjZU1hcFN1cHBvcnQoKTtcblxuLy8gVGhpcyBpcyBoYWNrIGZvciBzdXBwb3J0aW5nIHRoZSAnaW1wb3J0IHsgdCB9IGZyb20gXCJ0ZXN0Y2FmZVwiJyBleHByZXNzaW9uIGluIHRlc3RzLlxuLy8gSXQgY2F1c2VkIGJ5IHVzaW5nIHRoZSAnZXNtJyBtb2R1bGUuXG5yZXF1aXJlKCcuLi8uLi9hcGkvdGVzdC1jb250cm9sbGVyL3Byb3h5Jyk7XG5cbmludGVyZmFjZSBTZXJ2aWNlU3RhdGUge1xuICAgIHRlc3RSdW5zOiB7IFtpZDogc3RyaW5nXTogVGVzdFJ1blByb3h5IH07XG4gICAgZml4dHVyZUN0eHM6IHsgW2lkOiBzdHJpbmddOiBvYmplY3QgfTtcbiAgICB1bml0czogVW5pdHM7XG4gICAgb3B0aW9uczogRGljdGlvbmFyeTxPcHRpb25WYWx1ZT47XG4gICAgcm9sZXM6IE1hcDxzdHJpbmcsIFJvbGU+O1xufVxuXG5pbnRlcmZhY2UgV3JhcFNldE1vY2tBcmd1bWVudHMgZXh0ZW5kcyBSZXF1ZXN0SG9va0xvY2F0b3Ige1xuICAgIGV2ZW50OiBSZXF1ZXN0RXZlbnQ7XG59XG5cbmludGVyZmFjZSBJbml0VGVzdFJ1blByb3h5RGF0YSB7XG4gICAgdGVzdFJ1bklkOiBzdHJpbmc7XG4gICAgdGVzdDogVGVzdDtcbiAgICBicm93c2VyOiBCcm93c2VyO1xuICAgIGFjdGl2ZVdpbmRvd0lkOiBzdHJpbmcgfCBudWxsO1xuICAgIG1lc3NhZ2VCdXM/OiBNZXNzYWdlQnVzO1xufVxuXG5jbGFzcyBDb21waWxlclNlcnZpY2UgaW1wbGVtZW50cyBDb21waWxlclByb3RvY29sIHtcbiAgICBwcml2YXRlIHJlYWRvbmx5IHByb3h5OiBJUENQcm94eTtcbiAgICBwcml2YXRlIHJlYWRvbmx5IHN0YXRlOiBTZXJ2aWNlU3RhdGU7XG4gICAgcHJpdmF0ZSByZWFkb25seSBfcnVubmFibGVDb25maWd1cmF0aW9uVW5pdHNSZWxhdGlvbnM6IHsgW2lkOiBzdHJpbmddOiBzdHJpbmdbXSB9O1xuXG4gICAgcHVibGljIGNvbnN0cnVjdG9yICgpIHtcbiAgICAgICAgcHJvY2Vzcy50aXRsZSA9IFByb2Nlc3NUaXRsZS5zZXJ2aWNlO1xuXG4gICAgICAgIGNvbnN0IGlucHV0ICA9IGZzLmNyZWF0ZVJlYWRTdHJlYW0oJycsIHsgZmQ6IFNFUlZJQ0VfSU5QVVRfRkQgfSk7XG4gICAgICAgIGNvbnN0IG91dHB1dCA9IGZzLmNyZWF0ZVdyaXRlU3RyZWFtKCcnLCB7IGZkOiBTRVJWSUNFX09VVFBVVF9GRCB9KTtcblxuICAgICAgICB0aGlzLnByb3h5ID0gbmV3IElQQ1Byb3h5KG5ldyBTZXJ2aWNlVHJhbnNwb3J0KGlucHV0LCBvdXRwdXQsIFNFUlZJQ0VfU1lOQ19GRCkpO1xuICAgICAgICB0aGlzLnN0YXRlID0gdGhpcy5faW5pdFN0YXRlKCk7XG5cbiAgICAgICAgdGhpcy5fcnVubmFibGVDb25maWd1cmF0aW9uVW5pdHNSZWxhdGlvbnMgPSB7fTtcblxuICAgICAgICB0aGlzLl9yZWdpc3RlckVycm9ySGFuZGxlcnMoKTtcbiAgICAgICAgdGhpcy5fc2V0dXBSb3V0ZXMoKTtcbiAgICAgICAgdGhpcy5yZWFkeSgpO1xuICAgIH1cblxuICAgIHByaXZhdGUgX2luaXRTdGF0ZSAoKTogU2VydmljZVN0YXRlIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHRlc3RSdW5zOiAgICB7fSxcbiAgICAgICAgICAgIGZpeHR1cmVDdHhzOiB7fSxcbiAgICAgICAgICAgIHVuaXRzOiAgICAgICB7fSxcbiAgICAgICAgICAgIG9wdGlvbnM6ICAgICB7fSxcbiAgICAgICAgICAgIHJvbGVzOiAgICAgICBuZXcgTWFwPHN0cmluZywgUm9sZT4oKSxcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGFzeW5jIF9oYW5kbGVVbmV4cGVjdGVkRXJyb3IgKEVycm9yQ3RvcjogRnVuY3Rpb24sIGVycm9yOiBFcnJvcik6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICBjb25zdCBtZXNzYWdlID0gZm9ybWF0RXJyb3IoRXJyb3JDdG9yLCBlcnJvcik7XG4gICAgICAgIGNvbnN0IHR5cGUgICAgPSBFcnJvckN0b3IubmFtZTtcblxuICAgICAgICBhd2FpdCB0aGlzLmFkZFVuZXhwZWN0ZWRFcnJvcih7IHR5cGUsIG1lc3NhZ2UgfSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfcmVnaXN0ZXJFcnJvckhhbmRsZXJzICgpOiB2b2lkIHtcbiAgICAgICAgcHJvY2Vzcy5vbigndW5oYW5kbGVkUmVqZWN0aW9uJywgYXN5bmMgZSA9PiB0aGlzLl9oYW5kbGVVbmV4cGVjdGVkRXJyb3IoVW5oYW5kbGVkUHJvbWlzZVJlamVjdGlvbkVycm9yLCBlIGFzIEVycm9yKSk7XG4gICAgICAgIHByb2Nlc3Mub24oJ3VuY2F1Z2h0RXhjZXB0aW9uJywgYXN5bmMgZSA9PiB0aGlzLl9oYW5kbGVVbmV4cGVjdGVkRXJyb3IoVW5jYXVnaHRFeGNlcHRpb25FcnJvciwgZSBhcyBFcnJvcikpO1xuICAgIH1cblxuICAgIHByaXZhdGUgX2dldEZpeHR1cmVDdHggKHVuaXQ6IFVuaXQpOiBvYmplY3Qge1xuICAgICAgICBjb25zdCBmaXh0dXJlSWQgPSBpc1Rlc3QodW5pdCkgPyAodW5pdC5maXh0dXJlIGFzIEZpeHR1cmUpLmlkIDogKHVuaXQgYXMgRml4dHVyZSkuaWQ7XG5cbiAgICAgICAgcmV0dXJuIHRoaXMuc3RhdGUuZml4dHVyZUN0eHNbZml4dHVyZUlkXTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9nZXRUZXN0Q3R4ICh7IHRlc3RSdW5JZCB9OiBSdW5UZXN0QXJndW1lbnRzLCB1bml0OiBVbml0KTogVGVzdFJ1blByb3h5IHtcbiAgICAgICAgY29uc3QgdGVzdFJ1blByb3h5ID0gdGhpcy5fZ2V0VGFyZ2V0VGVzdFJ1bih0ZXN0UnVuSWQpO1xuXG4gICAgICAgIHRlc3RSdW5Qcm94eS5maXh0dXJlQ3R4ID0gdGhpcy5fZ2V0Rml4dHVyZUN0eCh1bml0KTtcblxuICAgICAgICByZXR1cm4gdGVzdFJ1blByb3h5O1xuICAgIH1cblxuICAgIHByaXZhdGUgX2dldENvbnRleHQgKGFyZ3M6IFJ1blRlc3RBcmd1bWVudHMsIHVuaXQ6IFVuaXQpOiBUZXN0UnVuUHJveHkgfCB1bmtub3duIHtcbiAgICAgICAgY29uc3QgeyB0ZXN0UnVuSWQgfSA9IGFyZ3M7XG5cbiAgICAgICAgaWYgKHRlc3RSdW5JZClcbiAgICAgICAgICAgIHJldHVybiB0aGlzLl9nZXRUZXN0Q3R4KGFyZ3MsIHVuaXQpO1xuXG4gICAgICAgIHJldHVybiB0aGlzLl9nZXRGaXh0dXJlQ3R4KHVuaXQpO1xuICAgIH1cblxuICAgIHByaXZhdGUgX3NldHVwUm91dGVzICgpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5wcm94eS5yZWdpc3RlcihbXG4gICAgICAgICAgICB0aGlzLmdldFRlc3RzLFxuICAgICAgICAgICAgdGhpcy5ydW5UZXN0Rm4sXG4gICAgICAgICAgICB0aGlzLmNsZWFuVXAsXG4gICAgICAgICAgICB0aGlzLnNldE9wdGlvbnMsXG4gICAgICAgICAgICB0aGlzLm9uUmVxdWVzdEhvb2tFdmVudCxcbiAgICAgICAgICAgIHRoaXMuc2V0TW9jayxcbiAgICAgICAgICAgIHRoaXMuc2V0Q29uZmlndXJlUmVzcG9uc2VFdmVudE9wdGlvbnMsXG4gICAgICAgICAgICB0aGlzLnNldEhlYWRlck9uQ29uZmlndXJlUmVzcG9uc2VFdmVudCxcbiAgICAgICAgICAgIHRoaXMucmVtb3ZlSGVhZGVyT25Db25maWd1cmVSZXNwb25zZUV2ZW50LFxuICAgICAgICAgICAgdGhpcy5leGVjdXRlUmVxdWVzdEZpbHRlclJ1bGVQcmVkaWNhdGUsXG4gICAgICAgICAgICB0aGlzLmV4ZWN1dGVNb2NrUHJlZGljYXRlLFxuICAgICAgICAgICAgdGhpcy5nZXRXYXJuaW5nTWVzc2FnZXMsXG4gICAgICAgICAgICB0aGlzLmFkZFJlcXVlc3RFdmVudExpc3RlbmVycyxcbiAgICAgICAgICAgIHRoaXMucmVtb3ZlUmVxdWVzdEV2ZW50TGlzdGVuZXJzLFxuICAgICAgICAgICAgdGhpcy5pbml0aWFsaXplVGVzdFJ1bkRhdGEsXG4gICAgICAgICAgICB0aGlzLmdldEFzc2VydGlvbkFjdHVhbFZhbHVlLFxuICAgICAgICAgICAgdGhpcy5leGVjdXRlUm9sZUluaXRGbixcbiAgICAgICAgICAgIHRoaXMuZ2V0Q3R4LFxuICAgICAgICAgICAgdGhpcy5nZXRGaXh0dXJlQ3R4LFxuICAgICAgICAgICAgdGhpcy5zZXRDdHgsXG4gICAgICAgICAgICB0aGlzLnNldEZpeHR1cmVDdHgsXG4gICAgICAgICAgICB0aGlzLnVwZGF0ZVJvbGVQcm9wZXJ0eSxcbiAgICAgICAgICAgIHRoaXMuZXhlY3V0ZUpzRXhwcmVzc2lvbixcbiAgICAgICAgICAgIHRoaXMuZXhlY3V0ZUFzeW5jSnNFeHByZXNzaW9uLFxuICAgICAgICAgICAgdGhpcy5hZGRVbmV4cGVjdGVkRXJyb3IsXG4gICAgICAgICAgICB0aGlzLmNoZWNrV2luZG93LFxuICAgICAgICAgICAgdGhpcy5yZW1vdmVUZXN0UnVuRnJvbVN0YXRlLFxuICAgICAgICAgICAgdGhpcy5yZW1vdmVGaXh0dXJlQ3R4c0Zyb21TdGF0ZSxcbiAgICAgICAgICAgIHRoaXMucmVtb3ZlVW5pdHNGcm9tU3RhdGUsXG4gICAgICAgIF0sIHRoaXMpO1xuICAgIH1cblxuICAgIHByaXZhdGUgX2dldEZ1bmN0aW9uICh1bml0OiBVbml0LCBmdW5jdGlvbk5hbWU6IEZ1bmN0aW9uUHJvcGVydGllcyk6IEZ1bmN0aW9ufG51bGwge1xuICAgICAgICBpZiAoaXNUZXN0KHVuaXQpICYmIGlzVGVzdEZ1bmN0aW9uUHJvcGVydHkoZnVuY3Rpb25OYW1lKSlcbiAgICAgICAgICAgIHJldHVybiB1bml0W2Z1bmN0aW9uTmFtZV07XG5cbiAgICAgICAgaWYgKGlzRml4dHVyZSh1bml0KSAmJiBpc0ZpeHR1cmVGdW5jdGlvblByb3BlcnR5KGZ1bmN0aW9uTmFtZSkpXG4gICAgICAgICAgICByZXR1cm4gdW5pdFtmdW5jdGlvbk5hbWVdO1xuXG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgQ2Fubm90IGZpbmQgJyR7ZnVuY3Rpb25OYW1lfScgZnVuY3Rpb24gZm9yICR7dHlwZW9mIHVuaXR9YCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfd3JhcEV2ZW50TWV0aG9kcyAoeyBuYW1lLCB0ZXN0SWQsIGhvb2tJZCwgZXZlbnREYXRhIH06IFJlcXVlc3RIb29rRXZlbnRBcmd1bWVudHMpOiB2b2lkIHtcbiAgICAgICAgaWYgKG5hbWUgPT09IFJlcXVlc3RIb29rTWV0aG9kTmFtZXMub25SZXF1ZXN0KVxuICAgICAgICAgICAgdGhpcy5fd3JhcFNldE1vY2tGbih7IHRlc3RJZCwgaG9va0lkLCBldmVudDogZXZlbnREYXRhIGFzIFJlcXVlc3RFdmVudCB9KTtcbiAgICAgICAgZWxzZSBpZiAobmFtZSA9PT0gUmVxdWVzdEhvb2tNZXRob2ROYW1lcy5fb25Db25maWd1cmVSZXNwb25zZSlcbiAgICAgICAgICAgIHRoaXMuX3dyYXBDb25maWd1cmVSZXNwb25zZUV2ZW50TWV0aG9kcyhldmVudERhdGEgYXMgQ29uZmlndXJlUmVzcG9uc2VFdmVudCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfd3JhcFNldE1vY2tGbiAoeyB0ZXN0SWQsIGhvb2tJZCwgZXZlbnQgfTogV3JhcFNldE1vY2tBcmd1bWVudHMpOiB2b2lkIHtcbiAgICAgICAgZXZlbnQuc2V0TW9jayA9IGFzeW5jIChtb2NrOiBSZXNwb25zZU1vY2spID0+IHtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuc2V0TW9jayh7XG4gICAgICAgICAgICAgICAgcmVzcG9uc2VFdmVudElkOiBldmVudC5pZCxcbiAgICAgICAgICAgICAgICBydWxlSWQ6ICAgICAgICAgIGV2ZW50LnJlcXVlc3RGaWx0ZXJSdWxlLmlkLFxuICAgICAgICAgICAgICAgIHRlc3RJZCxcbiAgICAgICAgICAgICAgICBob29rSWQsXG4gICAgICAgICAgICAgICAgbW9jayxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9O1xuICAgIH1cblxuICAgIHByaXZhdGUgX3dyYXBDb25maWd1cmVSZXNwb25zZUV2ZW50TWV0aG9kcyAoZXZlbnQ6IENvbmZpZ3VyZVJlc3BvbnNlRXZlbnQpOiB2b2lkIHtcbiAgICAgICAgZXZlbnQuc2V0SGVhZGVyID0gYXN5bmMgKG5hbWU6IHN0cmluZywgdmFsdWU6IHN0cmluZykgPT4ge1xuICAgICAgICAgICAgYXdhaXQgdGhpcy5zZXRIZWFkZXJPbkNvbmZpZ3VyZVJlc3BvbnNlRXZlbnQoe1xuICAgICAgICAgICAgICAgIGV2ZW50SWQ6ICAgICBldmVudC5pZCxcbiAgICAgICAgICAgICAgICBoZWFkZXJOYW1lOiAgbmFtZSxcbiAgICAgICAgICAgICAgICBoZWFkZXJWYWx1ZTogdmFsdWUsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfTtcblxuICAgICAgICBldmVudC5yZW1vdmVIZWFkZXIgPSBhc3luYyAobmFtZTogc3RyaW5nKSA9PiB7XG4gICAgICAgICAgICBhd2FpdCB0aGlzLnJlbW92ZUhlYWRlck9uQ29uZmlndXJlUmVzcG9uc2VFdmVudCh7XG4gICAgICAgICAgICAgICAgZXZlbnRJZDogICAgZXZlbnQuaWQsXG4gICAgICAgICAgICAgICAgaGVhZGVyTmFtZTogbmFtZSxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9O1xuICAgIH1cblxuICAgIHByaXZhdGUgX2luaXRpYWxpemVUZXN0UnVuUHJveHkgKHsgdGVzdFJ1bklkLCB0ZXN0LCBicm93c2VyLCBhY3RpdmVXaW5kb3dJZCwgbWVzc2FnZUJ1cyB9OiBJbml0VGVzdFJ1blByb3h5RGF0YSk6IHZvaWQge1xuICAgICAgICBjb25zdCB0ZXN0UnVuUHJveHkgPSBuZXcgVGVzdFJ1blByb3h5KHtcbiAgICAgICAgICAgIGRpc3BhdGNoZXI6IHRoaXMsXG4gICAgICAgICAgICBpZDogICAgICAgICB0ZXN0UnVuSWQsXG4gICAgICAgICAgICBvcHRpb25zOiAgICB0aGlzLnN0YXRlLm9wdGlvbnMsXG4gICAgICAgICAgICB0ZXN0LFxuICAgICAgICAgICAgYnJvd3NlcixcbiAgICAgICAgICAgIGFjdGl2ZVdpbmRvd0lkLFxuICAgICAgICAgICAgbWVzc2FnZUJ1cyxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5zdGF0ZS50ZXN0UnVuc1t0ZXN0UnVuSWRdID0gdGVzdFJ1blByb3h5O1xuICAgIH1cblxuICAgIHByaXZhdGUgX2luaXRpYWxpemVGaXh0dXJlQ3R4ICh0ZXN0OiBUZXN0KTogdm9pZCB7XG4gICAgICAgIGNvbnN0IGZpeHR1cmVJZCA9ICh0ZXN0LmZpeHR1cmUgYXMgRml4dHVyZSkuaWQ7XG5cbiAgICAgICAgaWYgKHRoaXMuc3RhdGUuZml4dHVyZUN0eHNbZml4dHVyZUlkXSlcbiAgICAgICAgICAgIHJldHVybjtcblxuICAgICAgICB0aGlzLnN0YXRlLmZpeHR1cmVDdHhzW2ZpeHR1cmVJZF0gPSBPYmplY3QuY3JlYXRlKG51bGwpO1xuICAgIH1cblxuICAgIHByaXZhdGUgX2dldFRhcmdldFRlc3RSdW4gKHRlc3RSdW5JZDogc3RyaW5nKTogVGVzdFJ1blByb3h5IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuc3RhdGUudGVzdFJ1bnNbdGVzdFJ1bklkXTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9nZXRUYXJnZXRSb2xlIChyb2xlSWQ6IHN0cmluZyk6IFJvbGUge1xuICAgICAgICByZXR1cm4gdGhpcy5zdGF0ZS5yb2xlcy5nZXQocm9sZUlkKSBhcyBSb2xlO1xuICAgIH1cblxuICAgIHByaXZhdGUgX3VwZGF0ZVVzZXJWYXJpYWJsZXMgKHZhbHVlOiBPcHRpb25WYWx1ZSk6IHZvaWQge1xuICAgICAgICB1c2VyVmFyaWFibGVzLnZhbHVlID0gdmFsdWU7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfZ2V0VW5pdElkcyAodGVzdHM6IFRlc3RbXSk6IHN0cmluZ1tdIHtcbiAgICAgICAgY29uc3QgdGVzdElkcyAgICAgPSB0ZXN0cy5tYXAodGVzdCA9PiB0ZXN0LmlkKTtcbiAgICAgICAgY29uc3QgZml4dHVyZUlkcyAgPSB0ZXN0cy5tYXAodGVzdCA9PiB0ZXN0LmZpeHR1cmU/LmlkKSBhcyBzdHJpbmdbXTtcbiAgICAgICAgY29uc3QgdGVzdEZpbGVJZHMgPSB0ZXN0cy5tYXAodGVzdCA9PiB0ZXN0LnRlc3RGaWxlLmlkKTtcblxuICAgICAgICByZXR1cm4gdW5pcShbLi4udGVzdElkcywgLi4uZml4dHVyZUlkcywgLi4udGVzdEZpbGVJZHNdKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgYXN5bmMgc2V0T3B0aW9ucyAoeyB2YWx1ZSB9OiBTZXRPcHRpb25zQXJndW1lbnRzKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIHRoaXMuc3RhdGUub3B0aW9ucyA9IHZhbHVlO1xuXG4gICAgICAgIHRoaXMuX3VwZGF0ZVVzZXJWYXJpYWJsZXModmFsdWUudXNlclZhcmlhYmxlcyk7XG4gICAgfVxuXG4gICAgcHVibGljIGFzeW5jIHJlYWR5ICgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgdGhpcy5wcm94eS5jYWxsKHRoaXMucmVhZHkpO1xuICAgIH1cblxuICAgIHB1YmxpYyBhc3luYyBjbGVhblVwICgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgYXdhaXQgQ29tcGlsZXIuY2xlYW5VcCgpO1xuICAgIH1cblxuICAgIHB1YmxpYyBhc3luYyBnZXRUZXN0cyAoeyBzb3VyY2VMaXN0LCBjb21waWxlck9wdGlvbnMsIHJ1bm5hYmxlQ29uZmlndXJhdGlvbklkIH06IENvbXBpbGVyQXJndW1lbnRzKTogUHJvbWlzZTxVbml0cz4ge1xuICAgICAgICBjb25zdCBjb21waWxlciA9IG5ldyBDb21waWxlcihzb3VyY2VMaXN0LCBjb21waWxlck9wdGlvbnMsIHRydWUpO1xuXG4gICAgICAgIGNvbnN0IHRlc3RzICAgPSBhd2FpdCBjb21waWxlci5nZXRUZXN0cygpO1xuICAgICAgICBjb25zdCB1bml0cyAgID0gZmxhdHRlblRlc3RTdHJ1Y3R1cmUodGVzdHMpO1xuICAgICAgICBjb25zdCB1bml0SWRzID0gdGhpcy5fZ2V0VW5pdElkcyh0ZXN0cyk7XG5cbiAgICAgICAgdGhpcy5fcnVubmFibGVDb25maWd1cmF0aW9uVW5pdHNSZWxhdGlvbnNbcnVubmFibGVDb25maWd1cmF0aW9uSWRdID0gdW5pdElkcztcblxuICAgICAgICBPYmplY3QuYXNzaWduKHRoaXMuc3RhdGUudW5pdHMsIHVuaXRzKTtcblxuICAgICAgICByZXR1cm4gc2VyaWFsaXplVGVzdFN0cnVjdHVyZSh1bml0cyk7XG4gICAgfVxuXG4gICAgcHVibGljIGFzeW5jIHJ1blRlc3RGbiAoYXJnczogUnVuVGVzdEFyZ3VtZW50cyk6IFByb21pc2U8dW5rbm93bj4ge1xuICAgICAgICBjb25zdCB7IGlkLCBmdW5jdGlvbk5hbWUgfSA9IGFyZ3M7XG5cbiAgICAgICAgY29uc3QgdW5pdCAgICAgICAgICAgPSB0aGlzLnN0YXRlLnVuaXRzW2lkXTtcbiAgICAgICAgY29uc3QgY29udGV4dCAgICAgICAgPSB0aGlzLl9nZXRDb250ZXh0KGFyZ3MsIHVuaXQpO1xuICAgICAgICBjb25zdCBmdW5jdGlvbk9iamVjdCA9IHRoaXMuX2dldEZ1bmN0aW9uKHVuaXQsIGZ1bmN0aW9uTmFtZSk7XG5cbiAgICAgICAgaWYgKCFmdW5jdGlvbk9iamVjdClcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgQ2Fubm90IGZpbmQgdGhlIFwiJHtmdW5jdGlvbk5hbWV9XCIgb2YgJHt0eXBlb2YgdW5pdH1gKTtcblxuICAgICAgICByZXR1cm4gYXdhaXQgZnVuY3Rpb25PYmplY3QoY29udGV4dCk7XG4gICAgfVxuXG4gICAgcHVibGljIGV4ZWN1dGVDb21tYW5kU3luYyAoeyBpZCwgY29tbWFuZCwgY2FsbHNpdGUgfTogRXhlY3V0ZUNvbW1hbmRBcmd1bWVudHMpOiB1bmtub3duIHtcbiAgICAgICAgcmV0dXJuIHRoaXMucHJveHkuY2FsbFN5bmModGhpcy5leGVjdXRlQ29tbWFuZCwgeyBpZCwgY29tbWFuZCwgY2FsbHNpdGUgfSk7XG4gICAgfVxuXG4gICAgcHVibGljIGFzeW5jIGV4ZWN1dGVDb21tYW5kICh7IGNvbW1hbmQsIGlkLCBjYWxsc2l0ZSB9OiBFeGVjdXRlQ29tbWFuZEFyZ3VtZW50cyk6IFByb21pc2U8dW5rbm93bj4ge1xuICAgICAgICByZXR1cm4gdGhpcy5wcm94eS5jYWxsKHRoaXMuZXhlY3V0ZUNvbW1hbmQsIHsgaWQsIGNvbW1hbmQsIGNhbGxzaXRlIH0pO1xuICAgIH1cblxuICAgIHB1YmxpYyBhc3luYyBvblJlcXVlc3RIb29rRXZlbnQgKHsgbmFtZSwgdGVzdElkLCBob29rSWQsIGV2ZW50RGF0YSB9OiBSZXF1ZXN0SG9va0V2ZW50QXJndW1lbnRzKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIHRoaXMuX3dyYXBFdmVudE1ldGhvZHMoeyBuYW1lLCB0ZXN0SWQsIGhvb2tJZCwgZXZlbnREYXRhIH0pO1xuXG4gICAgICAgIGNvbnN0IHRlc3QgICAgICAgPSB0aGlzLnN0YXRlLnVuaXRzW3Rlc3RJZF0gYXMgVGVzdDtcbiAgICAgICAgY29uc3QgdGFyZ2V0SG9vayA9IHRlc3QucmVxdWVzdEhvb2tzLmZpbmQoaG9vayA9PiBob29rLmlkID09PSBob29rSWQpIGFzIFJlcXVlc3RIb29rO1xuXG4gICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgYXdhaXQgdGFyZ2V0SG9va1tuYW1lXS5jYWxsKHRhcmdldEhvb2ssIGV2ZW50RGF0YSk7XG5cbiAgICAgICAgaWYgKG5hbWUgPT09IFJlcXVlc3RIb29rTWV0aG9kTmFtZXMuX29uQ29uZmlndXJlUmVzcG9uc2UgJiYgdGFyZ2V0SG9vay5fcmVzcG9uc2VFdmVudENvbmZpZ3VyZU9wdHMpIHtcbiAgICAgICAgICAgIGNvbnN0IHsgb3B0cywgaWQ6IGV2ZW50SWQgfSA9IGV2ZW50RGF0YSBhcyBDb25maWd1cmVSZXNwb25zZUV2ZW50O1xuXG4gICAgICAgICAgICBhd2FpdCB0aGlzLnNldENvbmZpZ3VyZVJlc3BvbnNlRXZlbnRPcHRpb25zKHsgZXZlbnRJZCwgb3B0cyB9KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1YmxpYyBhc3luYyBzZXRNb2NrICh7IHRlc3RJZCwgaG9va0lkLCBydWxlSWQsIHJlc3BvbnNlRXZlbnRJZCwgbW9jayB9OiBTZXRNb2NrQXJndW1lbnRzKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIGF3YWl0IHRoaXMucHJveHkuY2FsbCh0aGlzLnNldE1vY2ssIHsgdGVzdElkLCBob29rSWQsIHJ1bGVJZCwgcmVzcG9uc2VFdmVudElkLCBtb2NrIH0pO1xuICAgIH1cblxuICAgIHB1YmxpYyBhc3luYyBzZXRDb25maWd1cmVSZXNwb25zZUV2ZW50T3B0aW9ucyAoeyBldmVudElkLCBvcHRzIH06IFNldENvbmZpZ3VyZVJlc3BvbnNlRXZlbnRPcHRpb25zQXJndW1lbnRzKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIGF3YWl0IHRoaXMucHJveHkuY2FsbCh0aGlzLnNldENvbmZpZ3VyZVJlc3BvbnNlRXZlbnRPcHRpb25zLCB7IGV2ZW50SWQsIG9wdHMgfSk7XG4gICAgfVxuXG4gICAgcHVibGljIGFzeW5jIHNldEhlYWRlck9uQ29uZmlndXJlUmVzcG9uc2VFdmVudCAoeyBldmVudElkLCBoZWFkZXJOYW1lLCBoZWFkZXJWYWx1ZSB9OiBTZXRIZWFkZXJPbkNvbmZpZ3VyZVJlc3BvbnNlRXZlbnRBcmd1bWVudHMpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgYXdhaXQgdGhpcy5wcm94eS5jYWxsKHRoaXMuc2V0SGVhZGVyT25Db25maWd1cmVSZXNwb25zZUV2ZW50LCB7IGV2ZW50SWQsIGhlYWRlck5hbWUsIGhlYWRlclZhbHVlIH0pO1xuICAgIH1cblxuICAgIHB1YmxpYyBhc3luYyByZW1vdmVIZWFkZXJPbkNvbmZpZ3VyZVJlc3BvbnNlRXZlbnQgKHsgZXZlbnRJZCwgaGVhZGVyTmFtZSB9OiBSZW1vdmVIZWFkZXJPbkNvbmZpZ3VyZVJlc3BvbnNlRXZlbnRBcmd1bWVudHMpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgYXdhaXQgdGhpcy5wcm94eS5jYWxsKHRoaXMucmVtb3ZlSGVhZGVyT25Db25maWd1cmVSZXNwb25zZUV2ZW50LCB7IGV2ZW50SWQsIGhlYWRlck5hbWUgfSk7XG4gICAgfVxuXG4gICAgcHVibGljIGFzeW5jIGV4ZWN1dGVSZXF1ZXN0RmlsdGVyUnVsZVByZWRpY2F0ZSAoeyB0ZXN0SWQsIGhvb2tJZCwgcnVsZUlkLCByZXF1ZXN0SW5mbyB9OiBFeGVjdXRlUmVxdWVzdEZpbHRlclJ1bGVQcmVkaWNhdGVBcmd1bWVudHMpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICAgICAgY29uc3QgdGVzdCAgICAgICA9IHRoaXMuc3RhdGUudW5pdHNbdGVzdElkXSBhcyBUZXN0O1xuICAgICAgICBjb25zdCB0YXJnZXRIb29rID0gdGVzdC5yZXF1ZXN0SG9va3MuZmluZChob29rID0+IGhvb2suaWQgPT09IGhvb2tJZCkgYXMgUmVxdWVzdEhvb2s7XG4gICAgICAgIGNvbnN0IHRhcmdldFJ1bGUgPSB0YXJnZXRIb29rLl9yZXF1ZXN0RmlsdGVyUnVsZXMuZmluZChydWxlID0+IHJ1bGUuaWQgPT09IHJ1bGVJZCkgYXMgUmVxdWVzdEZpbHRlclJ1bGU7XG4gICAgICAgIGNvbnN0IHJlc3VsdCAgICAgPSBhd2FpdCB0YXJnZXRSdWxlLm9wdGlvbnMuY2FsbCh0YXJnZXRSdWxlLCByZXF1ZXN0SW5mbyk7XG5cbiAgICAgICAgcmV0dXJuICEhcmVzdWx0O1xuICAgIH1cblxuICAgIHB1YmxpYyBhc3luYyBleGVjdXRlTW9ja1ByZWRpY2F0ZSAoeyB0ZXN0SWQsIGhvb2tJZCwgcnVsZUlkLCByZXF1ZXN0SW5mbywgcmVzIH06IEV4ZWN1dGVNb2NrUHJlZGljYXRlKTogUHJvbWlzZTxJbmNvbWluZ01lc3NhZ2VMaWtlSW5pdE9wdGlvbnM+IHtcbiAgICAgICAgY29uc3QgdGVzdCAgICAgICAgID0gdGhpcy5zdGF0ZS51bml0c1t0ZXN0SWRdIGFzIFRlc3Q7XG4gICAgICAgIGNvbnN0IHJlcXVlc3RNb2NrICA9IHRlc3QucmVxdWVzdEhvb2tzLmZpbmQoaG9vayA9PiBob29rLmlkID09PSBob29rSWQpIGFzIFJlcXVlc3RNb2NrO1xuICAgICAgICBjb25zdCByZXNwb25zZU1vY2sgPSByZXF1ZXN0TW9jay5tb2Nrcy5nZXQocnVsZUlkKSBhcyBSZXNwb25zZU1vY2s7XG5cbiAgICAgICAgcmVzcG9uc2VNb2NrU2V0Qm9keU1ldGhvZC5hZGQocmVzKTtcblxuICAgICAgICByZXMgPSBPYmplY3QuYXNzaWduKHJlcywgYXdhaXQgKHJlc3BvbnNlTW9jay5ib2R5IGFzIEZ1bmN0aW9uKShyZXF1ZXN0SW5mbywgcmVzKSk7XG5cbiAgICAgICAgcmVzcG9uc2VNb2NrU2V0Qm9keU1ldGhvZC5yZW1vdmUocmVzKTtcblxuICAgICAgICByZXR1cm4gcmVzO1xuICAgIH1cblxuICAgIHB1YmxpYyBhc3luYyBnZXRXYXJuaW5nTWVzc2FnZXMgKHsgdGVzdFJ1bklkIH06IFRlc3RSdW5Mb2NhdG9yKTogUHJvbWlzZTxXYXJuaW5nTG9nTWVzc2FnZVtdPiB7XG4gICAgICAgIC8vIE5PVEU6IEluIGNhc2Ugb2YgcmFpc2luZyBhbiBlcnJvciBpbnRvIFJlcG9ydGVyUGx1Z2luSG9zdCBtZXRob2RzLFxuICAgICAgICAvLyBUZXN0UnVuIGhhcyB0aW1lIHRvIHN0YXJ0LlxuICAgICAgICBjb25zdCB0YXJnZXRUZXN0UnVuID0gdGhpcy5fZ2V0VGFyZ2V0VGVzdFJ1bih0ZXN0UnVuSWQpO1xuXG4gICAgICAgIHJldHVybiB0YXJnZXRUZXN0UnVuID8gdGFyZ2V0VGVzdFJ1bi53YXJuaW5nTG9nLm1lc3NhZ2VJbmZvcyA6IFtdO1xuICAgIH1cblxuICAgIHB1YmxpYyBhc3luYyBhZGRSZXF1ZXN0RXZlbnRMaXN0ZW5lcnMgKCB7IGhvb2tJZCwgaG9va0NsYXNzTmFtZSwgcnVsZXMgfTogQWRkUmVxdWVzdEV2ZW50TGlzdGVuZXJzQXJndW1lbnRzKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIHJldHVybiBhd2FpdCB0aGlzLnByb3h5LmNhbGwodGhpcy5hZGRSZXF1ZXN0RXZlbnRMaXN0ZW5lcnMsIHsgaG9va0lkLCBob29rQ2xhc3NOYW1lLCBydWxlcyB9KTtcbiAgICB9XG5cbiAgICBwdWJsaWMgYXN5bmMgcmVtb3ZlUmVxdWVzdEV2ZW50TGlzdGVuZXJzICh7IHJ1bGVzIH06IFJlbW92ZVJlcXVlc3RFdmVudExpc3RlbmVyc0FyZ3VtZW50cyk6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICByZXR1cm4gYXdhaXQgdGhpcy5wcm94eS5jYWxsKHRoaXMucmVtb3ZlUmVxdWVzdEV2ZW50TGlzdGVuZXJzLCB7IHJ1bGVzIH0pO1xuICAgIH1cblxuICAgIHB1YmxpYyBhc3luYyBpbml0aWFsaXplVGVzdFJ1bkRhdGEgKHsgdGVzdFJ1bklkLCB0ZXN0SWQsIGJyb3dzZXIsIGFjdGl2ZVdpbmRvd0lkLCBtZXNzYWdlQnVzIH06IEluaXRpYWxpemVUZXN0UnVuRGF0YUFyZ3VtZW50cyk6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICAvLyBOT1RFOiBJbiBjYXNlIG9mIHJhaXNpbmcgYW4gZXJyb3IgaW50byBSZXBvcnRlclBsdWdpbkhvc3QgbWV0aG9kcyxcbiAgICAgICAgLy8gVGVzdFJ1biBoYXMgdGltZSB0byBzdGFydC5cbiAgICAgICAgY29uc3QgdGVzdCA9IHRoaXMuc3RhdGUudW5pdHNbdGVzdElkXSBhcyBUZXN0O1xuXG4gICAgICAgIGlmICghdGVzdClcbiAgICAgICAgICAgIHJldHVybjtcblxuICAgICAgICB0aGlzLl9pbml0aWFsaXplVGVzdFJ1blByb3h5KHsgdGVzdFJ1bklkLCB0ZXN0LCBicm93c2VyLCBhY3RpdmVXaW5kb3dJZCwgbWVzc2FnZUJ1cyB9KTtcbiAgICAgICAgdGhpcy5faW5pdGlhbGl6ZUZpeHR1cmVDdHgodGVzdCk7XG4gICAgfVxuXG4gICAgcHVibGljIGVuYWJsZURlYnVnRm9yTm9uRGVidWdDb21tYW5kcyAoKTogdm9pZCB7XG4gICAgICAgIFRlc3RDb250cm9sbGVyLmVuYWJsZURlYnVnRm9yTm9uRGVidWdDb21tYW5kcygpO1xuICAgIH1cblxuICAgIHB1YmxpYyBkaXNhYmxlRGVidWdGb3JOb25EZWJ1Z0NvbW1hbmRzICgpOiB2b2lkIHtcbiAgICAgICAgVGVzdENvbnRyb2xsZXIuZGlzYWJsZURlYnVnRm9yTm9uRGVidWdDb21tYW5kcygpO1xuICAgIH1cblxuICAgIHB1YmxpYyBhc3luYyBnZXRBc3NlcnRpb25BY3R1YWxWYWx1ZSAoeyB0ZXN0UnVuSWQsIGNvbW1hbmRJZCB9OiBDb21tYW5kTG9jYXRvcik6IFByb21pc2U8dW5rbm93bj4ge1xuICAgICAgICByZXR1cm4gdGhpcy5fZ2V0VGFyZ2V0VGVzdFJ1bih0ZXN0UnVuSWQpLmdldEFzc2VydGlvbkFjdHVhbFZhbHVlKGNvbW1hbmRJZCk7XG4gICAgfVxuXG4gICAgcHVibGljIGFzeW5jIGV4ZWN1dGVSb2xlSW5pdEZuICh7IHRlc3RSdW5JZCwgcm9sZUlkIH06IEV4ZWN1dGVSb2xlSW5pdEZuQXJndW1lbnRzKTogUHJvbWlzZTx1bmtub3duPiB7XG4gICAgICAgIGNvbnN0IHJvbGUgICAgICAgICA9IHRoaXMuX2dldFRhcmdldFJvbGUocm9sZUlkKTtcbiAgICAgICAgY29uc3QgdGVzdFJ1blByb3h5ID0gdGhpcy5fZ2V0VGFyZ2V0VGVzdFJ1bih0ZXN0UnVuSWQpO1xuXG4gICAgICAgIHJldHVybiAocm9sZS5faW5pdEZuIGFzIEZ1bmN0aW9uKSh0ZXN0UnVuUHJveHkpO1xuICAgIH1cblxuICAgIHB1YmxpYyBhc3luYyBnZXRDdHggKHsgdGVzdFJ1bklkIH06IFRlc3RSdW5Mb2NhdG9yKTogUHJvbWlzZTxvYmplY3Q+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2dldFRhcmdldFRlc3RSdW4odGVzdFJ1bklkKS5jdHg7XG4gICAgfVxuXG4gICAgcHVibGljIGFzeW5jIGdldEZpeHR1cmVDdHggKHsgdGVzdFJ1bklkIH06IFRlc3RSdW5Mb2NhdG9yKTogUHJvbWlzZTxvYmplY3Q+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2dldFRhcmdldFRlc3RSdW4odGVzdFJ1bklkKS5maXh0dXJlQ3R4O1xuICAgIH1cblxuICAgIHB1YmxpYyBhc3luYyBzZXRDdHggKHsgdGVzdFJ1bklkLCB2YWx1ZSB9OiBTZXRDdHhBcmd1bWVudHMpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgdGhpcy5fZ2V0VGFyZ2V0VGVzdFJ1bih0ZXN0UnVuSWQpLmN0eCA9IHZhbHVlO1xuICAgIH1cblxuICAgIHB1YmxpYyBhc3luYyBzZXRGaXh0dXJlQ3R4ICh7IHRlc3RSdW5JZCwgdmFsdWUgfTogU2V0Q3R4QXJndW1lbnRzKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIHRoaXMuX2dldFRhcmdldFRlc3RSdW4odGVzdFJ1bklkKS5maXh0dXJlQ3R4ID0gdmFsdWU7XG4gICAgfVxuXG4gICAgcHVibGljIG9uUm9sZUFwcGVhcmVkIChyb2xlOiBSb2xlKTogdm9pZCB7XG4gICAgICAgIGlmICh0aGlzLnN0YXRlLnJvbGVzLmhhcyhyb2xlLmlkKSlcbiAgICAgICAgICAgIHJldHVybjtcblxuICAgICAgICB0aGlzLnN0YXRlLnJvbGVzLnNldChyb2xlLmlkLCByb2xlKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgYXN5bmMgdXBkYXRlUm9sZVByb3BlcnR5ICh7IHJvbGVJZCwgbmFtZSwgdmFsdWUgfTogVXBkYXRlUm9sZVByb3BlcnR5QXJndW1lbnRzKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIGNvbnN0IHJvbGUgPSB0aGlzLl9nZXRUYXJnZXRSb2xlKHJvbGVJZCk7XG5cbiAgICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgICByb2xlW25hbWVdID0gdmFsdWU7XG4gICAgfVxuXG4gICAgcHVibGljIGFzeW5jIGV4ZWN1dGVKc0V4cHJlc3Npb24gKHsgZXhwcmVzc2lvbiwgdGVzdFJ1bklkLCBvcHRpb25zIH06IEV4ZWN1dGVKc0V4cHJlc3Npb25Bcmd1bWVudHMpOiBQcm9taXNlPHVua25vd24+IHtcbiAgICAgICAgY29uc3QgdGVzdFJ1blByb3h5ID0gdGhpcy5fZ2V0VGFyZ2V0VGVzdFJ1bih0ZXN0UnVuSWQpO1xuXG4gICAgICAgIHJldHVybiBleGVjdXRlSnNFeHByZXNzaW9uKGV4cHJlc3Npb24sIHRlc3RSdW5Qcm94eSwgb3B0aW9ucyk7XG4gICAgfVxuXG4gICAgcHVibGljIGFzeW5jIGV4ZWN1dGVBc3luY0pzRXhwcmVzc2lvbiAoeyBleHByZXNzaW9uLCB0ZXN0UnVuSWQsIGNhbGxzaXRlIH06IEV4ZWN1dGVBc3luY0pzRXhwcmVzc2lvbkFyZ3VtZW50cyk6IFByb21pc2U8dW5rbm93bj4ge1xuICAgICAgICBjb25zdCB0ZXN0UnVuUHJveHkgPSB0aGlzLl9nZXRUYXJnZXRUZXN0UnVuKHRlc3RSdW5JZCk7XG5cbiAgICAgICAgcmV0dXJuIGV4ZWN1dGVBc3luY0pzRXhwcmVzc2lvbihleHByZXNzaW9uLCB0ZXN0UnVuUHJveHksIGNhbGxzaXRlLCBhc3luYyAoZXJyOiBVbmNhdWdodFRlc3RDYWZlRXJyb3JJbkN1c3RvbVNjcmlwdCB8IFVuY2F1Z2h0RXJyb3JJbkN1c3RvbVNjcmlwdCkgPT4ge1xuICAgICAgICAgICAgaWYgKGVyciBpbnN0YW5jZW9mIFVuY2F1Z2h0VGVzdENhZmVFcnJvckluQ3VzdG9tU2NyaXB0ID09PSBmYWxzZSlcbiAgICAgICAgICAgICAgICByZXR1cm47XG5cbiAgICAgICAgICAgIGNvbnN0IHRhcmdldEVycm9yID0gZXJyIGFzIFVuY2F1Z2h0VGVzdENhZmVFcnJvckluQ3VzdG9tU2NyaXB0O1xuXG4gICAgICAgICAgICBpZiAoIXNob3VsZFJlbmRlckh0bWxXaXRob3V0U3RhY2sodGFyZ2V0RXJyb3IpKVxuICAgICAgICAgICAgICAgIHJldHVybjtcblxuICAgICAgICAgICAgdGVzdFJ1blByb3h5LnJlc3RvcmVPcmlnaW5DYWxsc2l0ZUZvckVycm9yKHRhcmdldEVycm9yKTtcblxuICAgICAgICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgICAgICAgZXJyLmVyckNhbGxzaXRlID0gcmVuZGVySHRtbFdpdGhvdXRTdGFjayh0YXJnZXRFcnJvcik7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHB1YmxpYyBhc3luYyBleGVjdXRlQXNzZXJ0aW9uRm4gKHsgdGVzdFJ1bklkLCBjb21tYW5kSWQgfTogQ29tbWFuZExvY2F0b3IpOiBQcm9taXNlPHVua25vd24+IHtcbiAgICAgICAgcmV0dXJuIHRoaXNcbiAgICAgICAgICAgIC5fZ2V0VGFyZ2V0VGVzdFJ1bih0ZXN0UnVuSWQpXG4gICAgICAgICAgICAuZXhlY3V0ZUFzc2VydGlvbkZuKGNvbW1hbmRJZCk7XG4gICAgfVxuXG4gICAgcHVibGljIGFzeW5jIGFkZFVuZXhwZWN0ZWRFcnJvciAoeyB0eXBlLCBtZXNzYWdlIH06IEFkZFVuZXhwZWN0ZWRFcnJvckFyZ3VtZW50cyk6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICByZXR1cm4gdGhpcy5wcm94eS5jYWxsKHRoaXMuYWRkVW5leHBlY3RlZEVycm9yLCB7IHR5cGUsIG1lc3NhZ2UgfSk7XG4gICAgfVxuXG4gICAgcHVibGljIGFzeW5jIGNoZWNrV2luZG93ICh7IHRlc3RSdW5JZCwgY29tbWFuZElkLCB1cmwsIHRpdGxlIH06IENoZWNrV2luZG93QXJndW1lbnQpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzXG4gICAgICAgICAgICAgICAgLl9nZXRUYXJnZXRUZXN0UnVuKHRlc3RSdW5JZClcbiAgICAgICAgICAgICAgICAuY2hlY2tXaW5kb3coY29tbWFuZElkLCB7IHRpdGxlLCB1cmwgfSk7XG4gICAgICAgIH1cbiAgICAgICAgY2F0Y2ggKGVycikge1xuICAgICAgICAgICAgdGhyb3cgbmV3IFN3aXRjaFRvV2luZG93UHJlZGljYXRlRXJyb3IoZXJyLm1lc3NhZ2UpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIGFzeW5jIHJlbW92ZVRlc3RSdW5Gcm9tU3RhdGUgKHsgdGVzdFJ1bklkIH06IFRlc3RSdW5Mb2NhdG9yKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIGRlbGV0ZSB0aGlzLnN0YXRlLnRlc3RSdW5zW3Rlc3RSdW5JZF07XG4gICAgfVxuXG4gICAgcHVibGljIGFzeW5jIHJlbW92ZUZpeHR1cmVDdHhzRnJvbVN0YXRlICh7IGZpeHR1cmVJZHMgfTogUmVtb3ZlRml4dHVyZUN0eHNBcmd1bWVudHMpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgZm9yIChjb25zdCBmaXh0dXJlSWQgb2YgZml4dHVyZUlkcylcbiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLnN0YXRlLmZpeHR1cmVDdHhzW2ZpeHR1cmVJZF07XG4gICAgfVxuXG4gICAgcHVibGljIGFzeW5jIHJlbW92ZVVuaXRzRnJvbVN0YXRlICh7IHJ1bm5hYmxlQ29uZmlndXJhdGlvbklkIH06IFJlbW92ZVVuaXRzRnJvbVN0YXRlQXJndW1lbnRzKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIGNvbnN0IHVuaXRJZHMgPSB0aGlzLl9ydW5uYWJsZUNvbmZpZ3VyYXRpb25Vbml0c1JlbGF0aW9uc1tydW5uYWJsZUNvbmZpZ3VyYXRpb25JZF07XG5cbiAgICAgICAgZm9yIChjb25zdCB1bml0SWQgb2YgdW5pdElkcylcbiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLnN0YXRlLnVuaXRzW3VuaXRJZF07XG5cbiAgICAgICAgZGVsZXRlIHRoaXMuX3J1bm5hYmxlQ29uZmlndXJhdGlvblVuaXRzUmVsYXRpb25zW3J1bm5hYmxlQ29uZmlndXJhdGlvbklkXTtcbiAgICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IG5ldyBDb21waWxlclNlcnZpY2UoKTtcbiJdfQ==